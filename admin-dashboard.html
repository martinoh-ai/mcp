<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Masia Can Pares</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Space+Mono:wght@400;700&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <style>
        :root {
            --color-cream: #F5F0E1;
            --color-sage: #2D4A3E;
            --color-terracotta: #A65D57;
            --color-charcoal: #722F37;
            --color-mustard: #E9B84A;
            --color-text: #2C2825;
            --color-text-light: #6B635A;
            --font-display: 'Space Grotesk', sans-serif;
            --font-mono: 'Space Mono', monospace;
            --font-body: 'DM Sans', sans-serif;
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-body); background: #f5f5f5; color: var(--color-text); line-height: 1.6; }

        /* Loading Screen */
        .loading-screen { position: fixed; inset: 0; background: white; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .loading-screen.hidden { display: none; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(0,0,0,0.1); border-top-color: var(--color-charcoal); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Login Required */
        .login-required { display: none; min-height: 100vh; align-items: center; justify-content: center; flex-direction: column; gap: 20px; padding: 40px; text-align: center; }
        .login-required.show { display: flex; }
        .login-required h1 { font-family: var(--font-display); font-size: 1.5rem; }
        .login-required a { padding: 15px 30px; background: var(--color-charcoal); color: white; text-decoration: none; font-family: var(--font-mono); font-size: 0.8rem; letter-spacing: 0.1em; text-transform: uppercase; }

        /* Main App */
        .admin-app { display: none; }
        .admin-app.show { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--color-charcoal); color: white; position: fixed; top: 0; left: 0; bottom: 0; display: flex; flex-direction: column; }
        .sidebar__header { padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar__logo { height: 35px; filter: brightness(0) invert(1); margin-bottom: 8px; }
        .sidebar__title { font-family: var(--font-mono); font-size: 0.65rem; letter-spacing: 0.12em; text-transform: uppercase; opacity: 0.6; }
        .sidebar__nav { flex: 1; padding: 20px 0; }
        .sidebar__link { display: flex; align-items: center; gap: 12px; padding: 12px 20px; font-size: 0.9rem; color: rgba(255,255,255,0.7); cursor: pointer; transition: all 0.3s; }
        .sidebar__link:hover { background: rgba(255,255,255,0.05); color: white; }
        .sidebar__link.active { background: rgba(255,255,255,0.1); color: white; border-left: 3px solid var(--color-mustard); }
        .sidebar__link .material-symbols-outlined { font-size: 20px; }
        .sidebar__badge { margin-left: auto; background: var(--color-terracotta); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }
        .sidebar__footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .sidebar__user { display: flex; align-items: center; gap: 12px; }
        .sidebar__avatar { width: 40px; height: 40px; background: var(--color-sage); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .sidebar__logout { margin-top: 15px; width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: none; color: white; font-family: var(--font-mono); font-size: 0.7rem; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; border-radius: 6px; }
        .sidebar__logout:hover { background: rgba(255,255,255,0.15); }

        /* Main */
        .main { flex: 1; margin-left: 260px; }
        .main__header { background: white; padding: 20px 30px; border-bottom: 1px solid rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .main__title { font-family: var(--font-display); font-size: 1.4rem; font-weight: 600; }
        .main__content { padding: 30px; }

        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 12px; padding: 25px; }
        .stat-card__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .stat-card__icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .stat-card__icon--blue { background: rgba(45, 74, 62, 0.1); color: var(--color-sage); }
        .stat-card__icon--orange { background: rgba(166, 93, 87, 0.1); color: var(--color-terracotta); }
        .stat-card__icon--yellow { background: rgba(233, 184, 74, 0.15); color: #b8860b; }
        .stat-card__icon--purple { background: rgba(114, 47, 55, 0.1); color: var(--color-charcoal); }
        .stat-card__value { font-size: 2rem; font-weight: 700; margin-bottom: 5px; }
        .stat-card__label { font-size: 0.85rem; color: var(--color-text-light); }

        /* Card */
        .card { background: white; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .card__header { padding: 20px 25px; border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; align-items: center; justify-content: space-between; }
        .card__title { font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .card__body { padding: 25px; }

        /* Table */
        .table { width: 100%; border-collapse: collapse; }
        .table th { text-align: left; padding: 12px 15px; font-family: var(--font-mono); font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-text-light); border-bottom: 1px solid rgba(0,0,0,0.08); }
        .table td { padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.04); }
        .table tr:hover { background: rgba(0,0,0,0.02); }
        .table__status { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
        .table__status--confirmed { background: rgba(45, 74, 62, 0.1); color: var(--color-sage); }
        .table__status--pending { background: rgba(233, 184, 74, 0.2); color: #9a7a00; }
        .table__status--incomplete { background: rgba(166, 93, 87, 0.1); color: var(--color-terracotta); }
        .table__action { padding: 8px 15px; background: var(--color-cream); border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; margin-right: 8px; }
        .table__action:hover { background: #e5e0d1; }
        .table__action--primary { background: var(--color-charcoal); color: white; }

        /* Messages */
        .messages-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: calc(100vh - 180px); }
        .conversations-list { background: white; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }
        .conversations-list__header { padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.06); }
        .conversations-list__items { flex: 1; overflow-y: auto; }
        .conversation-item { padding: 15px 20px; border-bottom: 1px solid rgba(0,0,0,0.04); cursor: pointer; transition: background 0.2s; }
        .conversation-item:hover, .conversation-item.active { background: var(--color-cream); }
        .conversation-item__header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .conversation-item__avatar { width: 40px; height: 40px; background: var(--color-sage); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85rem; }
        .conversation-item__name { font-weight: 600; flex: 1; }
        .conversation-item__time { font-size: 0.75rem; color: var(--color-text-light); }
        .conversation-item__preview { font-size: 0.85rem; color: var(--color-text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .conversation-item__unread { width: 8px; height: 8px; background: var(--color-terracotta); border-radius: 50%; margin-left: 10px; }

        .chat-panel { background: white; border-radius: 12px; display: flex; flex-direction: column; }
        .chat-panel__header { padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; align-items: center; gap: 15px; }
        .chat-panel__info h3 { font-weight: 600; }
        .chat-panel__info p { font-size: 0.85rem; color: var(--color-text-light); }
        .chat-panel__messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .chat-message { max-width: 70%; }
        .chat-message--received { align-self: flex-start; }
        .chat-message--sent { align-self: flex-end; }
        .chat-message__bubble { padding: 12px 18px; border-radius: 16px; font-size: 0.95rem; line-height: 1.5; }
        .chat-message--received .chat-message__bubble { background: var(--color-cream); border-bottom-left-radius: 4px; }
        .chat-message--sent .chat-message__bubble { background: var(--color-charcoal); color: white; border-bottom-right-radius: 4px; }
        .chat-message__time { font-size: 0.7rem; color: var(--color-text-light); margin-top: 5px; }
        .chat-message--sent .chat-message__time { text-align: right; }
        .chat-panel__input { padding: 20px; border-top: 1px solid rgba(0,0,0,0.06); display: flex; gap: 15px; }
        .chat-panel__input input { flex: 1; padding: 14px 18px; border: 1px solid rgba(0,0,0,0.12); border-radius: 25px; font-size: 0.95rem; }
        .chat-panel__input input:focus { outline: none; border-color: var(--color-charcoal); }
        .chat-panel__send { width: 48px; height: 48px; background: var(--color-charcoal); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; }
        .chat-panel__send:hover { background: var(--color-terracotta); }
        .chat-panel__whatsapp { padding: 10px 20px; background: #25D366; color: white; border: none; border-radius: 8px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 8px; }

        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: #ccc; border-radius: 26px; transition: 0.3s; }
        .toggle-slider:before { content: ''; position: absolute; height: 20px; width: 20px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle-switch input:checked + .toggle-slider { background: #25D366; }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }

        /* Check-in Details */
        .checkin-details { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .guest-card { background: var(--color-cream); border-radius: 10px; padding: 20px; }
        .guest-card__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .guest-card__name { font-weight: 600; }
        .guest-card__status { padding: 4px 10px; border-radius: 10px; font-size: 0.7rem; }
        .guest-card__status--complete { background: rgba(45, 74, 62, 0.15); color: var(--color-sage); }
        .guest-card__row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.06); font-size: 0.9rem; }
        .guest-card__row:last-child { border-bottom: none; }
        .guest-card__label { color: var(--color-text-light); }
        .guest-card__id-link { color: var(--color-charcoal); text-decoration: underline; cursor: pointer; }

        /* Issues */
        .issue-card { background: var(--color-cream); border-radius: 10px; padding: 20px; margin-bottom: 15px; border-left: 4px solid var(--color-mustard); }
        .issue-card--high { border-color: var(--color-terracotta); }
        .issue-card--low { border-color: var(--color-sage); }
        .issue-card__header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .issue-card__location { font-weight: 600; }
        .issue-card__severity { font-size: 0.7rem; text-transform: uppercase; padding: 3px 8px; border-radius: 4px; background: rgba(0,0,0,0.1); }
        .issue-card__desc { color: var(--color-text-light); font-size: 0.9rem; margin-bottom: 10px; }
        .issue-card__meta { font-size: 0.8rem; color: var(--color-text-light); }
        .issue-card__actions { margin-top: 15px; display: flex; gap: 10px; }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--color-text-light); }
        .empty-state .material-symbols-outlined { font-size: 64px; opacity: 0.3; margin-bottom: 20px; }

        /* Mobile */
        @media (max-width: 1024px) {
            .sidebar { 
                transform: translateX(-100%); 
                z-index: 1000;
                transition: transform 0.3s ease;
            }
            .sidebar.open { 
                transform: translateX(0); 
            }
            .main { margin-left: 0; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .messages-layout { grid-template-columns: 1fr; }
            .checkin-details { grid-template-columns: 1fr; }
            .mobile-header {
                display: flex !important;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 60px;
                background: var(--color-charcoal);
                color: white;
                align-items: center;
                justify-content: space-between;
                padding: 0 15px;
                z-index: 999;
            }
            .main { padding-top: 80px; }
            .mobile-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            }
            .mobile-overlay.show { display: block; }
        }

        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; gap: 10px; }
            .stat-card { padding: 15px; }
            .stat-card__value { font-size: 1.5rem; }
            .header { flex-direction: column; align-items: flex-start; gap: 10px; padding: 15px; }
            .header__title { font-size: 1.3rem; }
            .main { padding: 70px 10px 20px 10px; }
            .card { border-radius: 10px; }
            .card__header { flex-direction: column; align-items: flex-start; gap: 10px; padding: 15px; }
            .card__body { padding: 15px; }
            .table { font-size: 0.8rem; }
            .table th, .table td { padding: 8px 5px; }
            .table__action { padding: 5px 8px; font-size: 0.7rem; }
            
            /* Stack table on mobile */
            .table thead { display: none; }
            .table, .table tbody, .table tr, .table td { display: block; width: 100%; }
            .table tr { margin-bottom: 15px; background: var(--color-cream); border-radius: 10px; padding: 10px; }
            .table td { padding: 8px 10px; border: none; display: flex; justify-content: space-between; align-items: center; }
            .table td::before { content: attr(data-label); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--color-text-light); }
            
            /* Calendar mobile */
            .fc .fc-toolbar { flex-direction: column; gap: 10px; }
            .fc .fc-toolbar-title { font-size: 1.1rem; }
        }

        .mobile-header { display: none; }
        .mobile-menu-btn { background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 5px; }
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
            <span class="material-symbols-outlined">menu</span>
        </button>
        <span style="font-family:var(--font-display);font-weight:600;">Can Pares Admin</span>
        <div style="width:40px;"></div>
    </div>
    <div class="mobile-overlay" id="mobile-overlay" onclick="toggleMobileMenu()"></div>

    <!-- Loading -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
    </div>

    <!-- Login Required -->
    <div class="login-required" id="login-required">
        <span class="material-symbols-outlined" style="font-size:64px;color:var(--color-terracotta);">lock</span>
        <h1>Admin Access Required</h1>
        <p>Please log in with your admin account.</p>
        <a href="login.html">Go to Login</a>
    </div>

    <!-- Admin App -->
    <div class="admin-app" id="admin-app">
        <aside class="sidebar">
            <div class="sidebar__header">
                <img src="cdn/logos/canpares-logo.webp" alt="Can Pares" class="sidebar__logo">
                <div class="sidebar__title">Admin Dashboard</div>
            </div>
            <nav class="sidebar__nav">
                <div class="sidebar__link active" data-tab="overview">
                    <span class="material-symbols-outlined">dashboard</span>
                    Overview
                </div>
                <div class="sidebar__link" data-tab="bookings">
                    <span class="material-symbols-outlined">calendar_month</span>
                    Bookings
                </div>
                <div class="sidebar__link" data-tab="calendar">
                    <span class="material-symbols-outlined">event</span>
                    Calendar
                </div>
                <div class="sidebar__link" data-tab="messages">
                    <span class="material-symbols-outlined">chat</span>
                    Messages
                    <span class="sidebar__badge" id="unread-count">0</span>
                </div>
                <div class="sidebar__link" data-tab="checkins">
                    <span class="material-symbols-outlined">how_to_reg</span>
                    Check-ins
                </div>
                <div class="sidebar__link" data-tab="issues">
                    <span class="material-symbols-outlined">report_problem</span>
                    Issues
                    <span class="sidebar__badge" id="issues-badge">0</span>
                </div>
                <div class="sidebar__link" data-tab="cleaning">
                    <span class="material-symbols-outlined">cleaning_services</span>
                    Cleaning
                </div>
                <div class="sidebar__link" data-tab="services">
                    <span class="material-symbols-outlined">room_service</span>
                    Services
                    <span class="sidebar__badge" id="orders-badge">0</span>
                </div>
                <div class="sidebar__link" data-tab="documents">
                    <span class="material-symbols-outlined">folder</span>
                    Documents
                </div>
                <div class="sidebar__link" data-tab="settings">
                    <span class="material-symbols-outlined">settings</span>
                    Settings
                </div>
            </nav>
            <div class="sidebar__footer">
                <div class="sidebar__user">
                    <div class="sidebar__avatar">M</div>
                    <div>
                        <div style="font-size:0.9rem;font-weight:500;">Martin</div>
                        <div style="font-size:0.75rem;opacity:0.6;">Admin</div>
                    </div>
                </div>
                <button class="sidebar__logout" onclick="logout()">
                    <span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;margin-right:5px;">logout</span>
                    Sign Out
                </button>
            </div>
        </aside>

        <main class="main">
            <header class="main__header">
                <h1 class="main__title" id="page-title">Overview</h1>
                <div style="font-family:var(--font-mono);font-size:0.8rem;color:var(--color-text-light);" id="current-date"></div>
            </header>

            <div class="main__content">
                <!-- Overview Tab -->
                <div class="tab-content active" id="overview">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card__header">
                                <div class="stat-card__icon stat-card__icon--blue"><span class="material-symbols-outlined">calendar_month</span></div>
                            </div>
                            <div class="stat-card__value" id="stat-bookings">0</div>
                            <div class="stat-card__label">Active Bookings</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card__header">
                                <div class="stat-card__icon stat-card__icon--orange"><span class="material-symbols-outlined">chat</span></div>
                            </div>
                            <div class="stat-card__value" id="stat-messages">0</div>
                            <div class="stat-card__label">Unread Messages</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card__header">
                                <div class="stat-card__icon stat-card__icon--yellow"><span class="material-symbols-outlined">how_to_reg</span></div>
                            </div>
                            <div class="stat-card__value" id="stat-checkins">0</div>
                            <div class="stat-card__label">Pending Check-ins</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card__header">
                                <div class="stat-card__icon stat-card__icon--purple"><span class="material-symbols-outlined">report_problem</span></div>
                            </div>
                            <div class="stat-card__value" id="stat-issues">0</div>
                            <div class="stat-card__label">Open Issues</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">schedule</span> Upcoming Arrivals</span>
                        </div>
                        <div class="card__body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Guest</th>
                                        <th>Property</th>
                                        <th>Check-in</th>
                                        <th>Nights</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="upcoming-bookings">
                                    <tr><td colspan="6" class="empty-state" style="padding:40px;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Bookings Tab -->
                <div class="tab-content" id="bookings">
                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">calendar_month</span> All Bookings</span>
                            <div style="display:flex;gap:10px;">
                                <button class="table__action" onclick="syncBeds24()" id="sync-btn">
                                    <span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;">sync</span> Sync Beds24
                                </button>
                            </div>
                        </div>
                        <div class="card__body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Guest</th>
                                        <th>Property</th>
                                        <th>Check-in</th>
                                        <th>Check-out</th>
                                        <th>Nights</th>
                                        <th>Amount</th>
                                        <th>Source</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="all-bookings">
                                    <tr><td colspan="9" class="empty-state" style="padding:40px;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Calendar Tab -->
                <div class="tab-content" id="calendar">
                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">event</span> Reservations Calendar</span>
                            <div style="display:flex;gap:10px;">
                                <div style="display:flex;align-items:center;gap:5px;font-size:0.8rem;">
                                    <span style="width:12px;height:12px;background:#2D4A3E;border-radius:3px;"></span> Casa Blanca
                                </div>
                                <div style="display:flex;align-items:center;gap:5px;font-size:0.8rem;">
                                    <span style="width:12px;height:12px;background:#A65D57;border-radius:3px;"></span> Casa Mediterranea
                                </div>
                            </div>
                        </div>
                        <div class="card__body">
                            <div id="calendar-view" style="min-height:600px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Messages Tab -->
                <div class="tab-content" id="messages">
                    <div class="messages-layout">
                        <div class="conversations-list">
                            <div class="conversations-list__header">
                                <input type="text" placeholder="Search conversations..." style="width:100%;padding:10px 15px;border:1px solid rgba(0,0,0,0.1);border-radius:8px;">
                            </div>
                            <div class="conversations-list__items" id="conversations-list">
                                <div class="empty-state" style="padding:40px;">Loading...</div>
                            </div>
                        </div>
                        <div class="chat-panel">
                            <div class="chat-panel__header" id="chat-header" style="display:none;">
                                <div class="conversation-item__avatar" id="chat-avatar">JD</div>
                                <div class="chat-panel__info">
                                    <h3 id="chat-name">Select a conversation</h3>
                                    <p id="chat-booking">-</p>
                                </div>
                                <button class="chat-panel__whatsapp" id="whatsapp-btn" style="margin-left:auto;">
                                    <span class="material-symbols-outlined">chat</span>
                                    WhatsApp
                                </button>
                            </div>
                            <div class="chat-panel__messages" id="chat-messages">
                                <div class="empty-state">
                                    <span class="material-symbols-outlined">forum</span>
                                    <p>Select a conversation to view messages</p>
                                </div>
                            </div>
                            <div class="chat-panel__input" id="chat-input" style="display:none;">
                                <input type="text" placeholder="Type your reply..." id="message-input">
                                <button class="chat-panel__send" onclick="sendMessage()">
                                    <span class="material-symbols-outlined">send</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Check-ins Tab -->
                <div class="tab-content" id="checkins">
                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">how_to_reg</span> Guest Registrations</span>
                        </div>
                        <div class="card__body" id="checkins-list">
                            <div class="empty-state" style="padding:40px;">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Issues Tab -->
                <div class="tab-content" id="issues">
                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">report_problem</span> Reported Issues</span>
                        </div>
                        <div class="card__body" id="issues-list">
                            <div class="empty-state" style="padding:40px;">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Cleaning Tab -->
                <div class="tab-content" id="cleaning">
                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">cleaning_services</span> Cleaning Sessions</span>
                        </div>
                        <div class="card__body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Property</th>
                                        <th>Type</th>
                                        <th>Staff</th>
                                        <th>Duration</th>
                                        <th>Issues</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="cleaning-sessions">
                                    <tr><td colspan="7" class="empty-state" style="padding:40px;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">inventory_2</span> Inventory Alerts</span>
                        </div>
                        <div class="card__body" id="inventory-alerts">
                            <div class="empty-state" style="padding:40px;">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-content" id="settings">
                    <!-- Communication Settings -->
                    <div class="card" style="margin-bottom:20px;">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">chat</span> Communication Settings</span>
                        </div>
                        <div class="card__body" style="padding:25px;">
                            <div style="display:flex;align-items:center;justify-content:space-between;padding:15px 0;border-bottom:1px solid rgba(0,0,0,0.08);">
                                <div>
                                    <div style="font-weight:600;margin-bottom:5px;display:flex;align-items:center;gap:10px;">
                                        <span style="color:#25D366;">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                                        </span>
                                        WhatsApp Integration
                                    </div>
                                    <div style="font-size:0.85rem;color:var(--color-text-light);">Show WhatsApp buttons to contact guests directly</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="whatsapp-toggle" onchange="toggleWhatsApp(this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div id="whatsapp-number-config" style="padding:15px 0;display:none;">
                                <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">WhatsApp Business Number</label>
                                <div style="display:flex;gap:10px;">
                                    <input type="text" id="whatsapp-number-input" placeholder="+34 612 345 678" style="flex:1;padding:12px 15px;border:1px solid rgba(0,0,0,0.1);border-radius:8px;font-size:0.95rem;">
                                    <button onclick="saveWhatsAppNumber()" class="table__action table__action--primary">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">home</span> Properties & Tasks</span>
                            <button class="table__action table__action--primary" onclick="addProperty()">
                                <span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;">add</span> Add Property
                            </button>
                        </div>
                        <div class="card__body" id="properties-config">
                            <div class="empty-state" style="padding:40px;">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Documents Tab -->
                <div class="tab-content" id="documents">
                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">folder</span> Guest Documents & Guides</span>
                            <button class="table__action table__action--primary" onclick="addDocument()">
                                <span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;">add</span> Add Document
                            </button>
                        </div>
                        <div class="card__body" id="documents-config">
                            <div class="empty-state" style="padding:40px;">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Services Tab -->
                <div class="tab-content" id="services">
                    <div class="card" style="margin-bottom:20px;">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">room_service</span> Services Catalog</span>
                            <button class="table__action table__action--primary" onclick="addService()">
                                <span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;">add</span> Add Service
                            </button>
                        </div>
                        <div class="card__body" id="services-catalog">
                            <div class="empty-state" style="padding:40px;">Loading...</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__header">
                            <span class="card__title"><span class="material-symbols-outlined">shopping_cart</span> Recent Orders</span>
                        </div>
                        <div class="card__body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Guest</th>
                                        <th>Service</th>
                                        <th>When</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-list">
                                    <tr><td colspan="7" class="empty-state">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Service Edit Modal -->
                <div id="service-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
                    <div style="background:white;border-radius:12px;max-width:500px;width:90%;max-height:90vh;overflow:auto;padding:30px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h2 style="font-family:var(--font-display);" id="service-modal-title">Add Service</h2>
                            <button onclick="closeServiceModal()" style="background:none;border:none;cursor:pointer;font-size:24px;">&times;</button>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Service Name</label>
                            <input type="text" id="service-name" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;" placeholder="Breakfast">
                        </div>

                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Description</label>
                            <textarea id="service-description" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;min-height:80px;" placeholder="Fresh local breakfast delivered to your door"></textarea>
                        </div>

                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;">
                            <div>
                                <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Price (‚Ç¨)</label>
                                <input type="number" id="service-price" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;" placeholder="25" min="0" step="0.01">
                            </div>
                            <div>
                                <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Price Type</label>
                                <select id="service-price-type" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;">
                                    <option value="per_person">Per person</option>
                                    <option value="per_unit">Per unit</option>
                                    <option value="per_hour">Per hour</option>
                                    <option value="fixed">Fixed price</option>
                                </select>
                            </div>
                        </div>

                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Category</label>
                            <select id="service-category" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;">
                                <option value="food">üçΩÔ∏è Food & Drinks</option>
                                <option value="wellness">üíÜ Wellness</option>
                                <option value="activities">üéØ Activities</option>
                                <option value="transport">üöó Transport</option>
                                <option value="household">üè† Household</option>
                            </select>
                        </div>

                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Icon</label>
                            <select id="service-icon" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;">
                                <option value="bakery_dining">ü•ê Breakfast</option>
                                <option value="restaurant">üçΩÔ∏è Dinner</option>
                                <option value="local_cafe">‚òï Coffee</option>
                                <option value="wine_bar">üç∑ Wine</option>
                                <option value="spa">üíÜ Massage/Spa</option>
                                <option value="self_improvement">üßò Yoga</option>
                                <option value="pool">üèä Pool</option>
                                <option value="directions_car">üöó Transport</option>
                                <option value="local_taxi">üöï Taxi</option>
                                <option value="shopping_cart">üõí Groceries</option>
                                <option value="dry_cleaning">üß∫ Laundry</option>
                                <option value="cleaning_services">üßπ Cleaning</option>
                                <option value="child_care">üë∂ Babysitting</option>
                                <option value="pets">üêï Pet care</option>
                                <option value="hiking">ü•æ Hiking</option>
                                <option value="kayaking">üö£ Water sports</option>
                            </select>
                        </div>

                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Advance Notice Required</label>
                            <select id="service-notice" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;">
                                <option value="0">No advance notice</option>
                                <option value="2">2 hours</option>
                                <option value="12">12 hours</option>
                                <option value="24">24 hours (1 day)</option>
                                <option value="48">48 hours (2 days)</option>
                                <option value="72">72 hours (3 days)</option>
                            </select>
                        </div>

                        <div style="margin-bottom:20px;">
                            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                                <input type="checkbox" id="service-active" checked style="width:20px;height:20px;">
                                <span>Service is active and visible to guests</span>
                            </label>
                        </div>

                        <div style="display:flex;gap:10px;justify-content:flex-end;">
                            <button class="table__action" onclick="closeServiceModal()">Cancel</button>
                            <button class="table__action table__action--primary" onclick="saveService()">Save Service</button>
                        </div>
                    </div>
                </div>

                <!-- Document Edit Modal -->
                <div id="document-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
                    <div style="background:white;border-radius:12px;max-width:500px;width:90%;padding:30px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h2 style="font-family:var(--font-display);" id="doc-modal-title">Add Document</h2>
                            <button onclick="closeDocumentModal()" style="background:none;border:none;cursor:pointer;font-size:24px;">&times;</button>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Document Name</label>
                            <input type="text" id="doc-name" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;" placeholder="House Guide">
                        </div>

                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Description</label>
                            <input type="text" id="doc-description" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;" placeholder="WiFi, appliances, local tips">
                        </div>

                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Icon</label>
                            <select id="doc-icon" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;">
                                <option value="home">üè† House</option>
                                <option value="map">üó∫Ô∏è Map</option>
                                <option value="restaurant">üçΩÔ∏è Restaurant</option>
                                <option value="wifi">üì∂ WiFi</option>
                                <option value="pool">üèä Pool</option>
                                <option value="emergency">üö® Emergency</option>
                                <option value="directions_car">üöó Transport</option>
                                <option value="local_activity">üéØ Activities</option>
                                <option value="shopping_bag">üõçÔ∏è Shopping</option>
                                <option value="spa">üíÜ Wellness</option>
                                <option value="wine_bar">üç∑ Wine</option>
                                <option value="hiking">ü•æ Hiking</option>
                            </select>
                        </div>

                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Document Link (Google Drive, Dropbox, or URL)</label>
                            <input type="url" id="doc-url" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;" placeholder="https://drive.google.com/...">
                        </div>

                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Order (1 = first)</label>
                            <input type="number" id="doc-order" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;" value="1" min="1">
                        </div>

                        <div style="display:flex;gap:10px;justify-content:flex-end;">
                            <button class="table__action" onclick="closeDocumentModal()">Cancel</button>
                            <button class="table__action table__action--primary" onclick="saveDocument()">Save Document</button>
                        </div>
                    </div>
                </div>

                <!-- Property Edit Modal -->
                <div id="property-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
                    <div style="background:white;border-radius:12px;max-width:800px;width:90%;max-height:90vh;overflow:auto;padding:30px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h2 style="font-family:var(--font-display);" id="modal-title">Edit Property</h2>
                            <button onclick="closePropertyModal()" style="background:none;border:none;cursor:pointer;font-size:24px;">&times;</button>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Property Name</label>
                            <input type="text" id="prop-name" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;">
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Property ID (no spaces)</label>
                            <input type="text" id="prop-id" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;" placeholder="casa-blanca">
                        </div>

                        <div style="margin-bottom:20px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                <label style="font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);">Rooms & Tasks</label>
                                <button class="table__action" onclick="addRoom()"><span class="material-symbols-outlined" style="font-size:14px;vertical-align:middle;">add</span> Add Room</button>
                            </div>
                            <div id="rooms-config" style="display:flex;flex-direction:column;gap:15px;"></div>
                        </div>

                        <div style="margin-bottom:20px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                <label style="font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);">Inventory Items</label>
                                <button class="table__action" onclick="addInventoryItem()"><span class="material-symbols-outlined" style="font-size:14px;vertical-align:middle;">add</span> Add Item</button>
                            </div>
                            <div id="inventory-config" style="display:flex;flex-direction:column;gap:10px;"></div>
                        </div>

                        <div style="display:flex;gap:10px;justify-content:flex-end;">
                            <button class="table__action" onclick="closePropertyModal()">Cancel</button>
                            <button class="table__action table__action--primary" onclick="saveProperty()">Save Property</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <script>
        // =====================================================
        // üî• FIREBASE CONFIG - REMPLACEZ AVEC VOS VALEURS
        // =====================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDlqtcXUqEctwsvLbXzGOenleNPDwOj4n4",
            authDomain: "masia-can-pares.firebaseapp.com",
            projectId: "masia-can-pares",
            storageBucket: "masia-can-pares.firebasestorage.app",
            messagingSenderId: "898469617158",
            appId: "1:898469617158:web:94f57c383501f81b9d2d87"
        };

        // üì± WHATSAPP NUMBER
        let WHATSAPP_NUMBER = "34612345678"; // Votre num√©ro WhatsApp Business
        let whatsappEnabled = false; // WhatsApp toggle state

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // =====================================================
        // AUTH CHECK
        // =====================================================
        let currentUser = null;
        let currentConversation = null;

        auth.onAuthStateChanged(async (user) => {
            document.getElementById('loading-screen').classList.add('hidden');
            
            if (user) {
                // Check if admin
                const adminDoc = await db.collection('admins').doc(user.uid).get();
                if (adminDoc.exists) {
                    currentUser = user;
                    document.getElementById('admin-app').classList.add('show');
                    initDashboard();
                } else {
                    document.getElementById('login-required').classList.add('show');
                }
            } else {
                document.getElementById('login-required').classList.add('show');
            }
        });

        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }

        // =====================================================
        // WHATSAPP SETTINGS
        // =====================================================
        function loadWhatsAppSettings() {
            db.collection('settings').doc('whatsapp').get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    whatsappEnabled = data.enabled || false;
                    WHATSAPP_NUMBER = data.number || "34612345678";
                    
                    document.getElementById('whatsapp-toggle').checked = whatsappEnabled;
                    document.getElementById('whatsapp-number-input').value = WHATSAPP_NUMBER;
                    document.getElementById('whatsapp-number-config').style.display = whatsappEnabled ? 'block' : 'none';
                }
                updateWhatsAppVisibility();
            }).catch(err => {
                console.log('No WhatsApp settings found, using defaults');
                updateWhatsAppVisibility();
            });
        }

        function toggleWhatsApp(enabled) {
            whatsappEnabled = enabled;
            document.getElementById('whatsapp-number-config').style.display = enabled ? 'block' : 'none';
            
            db.collection('settings').doc('whatsapp').set({
                enabled: enabled,
                number: WHATSAPP_NUMBER
            }, { merge: true }).then(() => {
                updateWhatsAppVisibility();
                console.log('WhatsApp settings saved');
            });
        }

        function saveWhatsAppNumber() {
            const number = document.getElementById('whatsapp-number-input').value.replace(/[^0-9]/g, '');
            if (!number) {
                alert('Please enter a valid phone number');
                return;
            }
            
            WHATSAPP_NUMBER = number;
            db.collection('settings').doc('whatsapp').set({
                enabled: whatsappEnabled,
                number: number
            }, { merge: true }).then(() => {
                alert('WhatsApp number saved!');
            });
        }

        function updateWhatsAppVisibility() {
            // Show/hide all WhatsApp buttons
            document.querySelectorAll('.whatsapp-btn, .chat-panel__whatsapp, [data-whatsapp]').forEach(btn => {
                btn.style.display = whatsappEnabled ? '' : 'none';
            });
        }

        // =====================================================
        // DASHBOARD INIT
        // =====================================================
        function initDashboard() {
            // Set date
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            // Load data
            loadStats();
            loadBookings();
            loadConversations();
            loadCheckins();
            loadIssues();
            loadCleaningSessions();
            loadPropertiesConfig();
            loadDocuments();
            loadServices();
            loadOrders();
            loadWhatsAppSettings(); // Load WhatsApp settings

            // Tab navigation
            document.querySelectorAll('.sidebar__link').forEach(link => {
                link.addEventListener('click', () => {
                    const tab = link.dataset.tab;
                    document.querySelectorAll('.sidebar__link').forEach(l => l.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    link.classList.add('active');
                    document.getElementById(tab).classList.add('active');
                    
                    // Close mobile menu
                    closeMobileMenu();
                    
                    // Load calendar when tab is clicked
                    if (tab === 'calendar') {
                        loadCalendar();
                    }
                    
                    var titles = {
                        overview: 'Overview',
                        bookings: 'Bookings',
                        calendar: 'Calendar',
                        messages: 'Messages',
                        checkins: 'Check-ins',
                        issues: 'Issues',
                        cleaning: 'Cleaning',
                        services: 'Services',
                        documents: 'Documents',
                        settings: 'Settings'
                    };
                    document.getElementById('page-title').textContent = titles[tab] || 'Dashboard';
                });
            });
        }

        // Mobile menu functions
        function toggleMobileMenu() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.getElementById('mobile-overlay').classList.toggle('show');
        }
        
        function closeMobileMenu() {
            document.querySelector('.sidebar').classList.remove('open');
            document.getElementById('mobile-overlay').classList.remove('show');
        }

        // =====================================================
        // LOAD DATA
        // =====================================================
        async function loadStats() {
            try {
                const bookings = await db.collection('bookings').where('status', '==', 'confirmed').get();
                document.getElementById('stat-bookings').textContent = bookings.size;

                const convos = await db.collection('conversations').where('unreadByHost', '>', 0).get();
                document.getElementById('stat-messages').textContent = convos.size;
                document.getElementById('unread-count').textContent = convos.size;

                const checkins = await db.collection('checkins').where('status', '==', 'incomplete').get();
                document.getElementById('stat-checkins').textContent = checkins.size;

                const issues = await db.collection('issues').where('status', '==', 'open').get();
                document.getElementById('stat-issues').textContent = issues.size;
                document.getElementById('issues-badge').textContent = issues.size;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadBookings() {
            try {
                const snapshot = await db.collection('bookings').orderBy('checkIn', 'desc').limit(50).get();
                
                if (snapshot.empty) {
                    document.getElementById('upcoming-bookings').innerHTML = '<tr><td colspan="6" class="empty-state">No bookings yet</td></tr>';
                    document.getElementById('all-bookings').innerHTML = '<tr><td colspan="9" class="empty-state">No bookings yet. Click "Sync Beds24" to import.</td></tr>';
                    return;
                }

                let upcomingHtml = '';
                let allHtml = '';
                const now = new Date();

                snapshot.forEach(doc => {
                    const b = doc.data();
                    const checkIn = b.checkIn?.toDate?.() || new Date(b.checkIn);
                    const checkOut = b.checkOut?.toDate?.() || new Date(b.checkOut);
                    const nights = b.nights || Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
                    const isUpcoming = checkIn >= now;

                    // Source badge color
                    const sourceColors = {
                        'Direct': '#2D4A3E',
                        'Airbnb': '#FF5A5F',
                        'Booking.com': '#003580',
                        'VRBO': '#3D67A6',
                        'default': '#6B635A'
                    };
                    const source = b.source || 'Direct';
                    const sourceColor = sourceColors[source] || sourceColors['default'];

                    if (isUpcoming) {
                        upcomingHtml += `
                            <tr>
                                <td><strong>${b.guestName || 'Guest'}</strong></td>
                                <td>${b.property || '-'}</td>
                                <td>${checkIn.toLocaleDateString()}</td>
                                <td>${nights}</td>
                                <td><span class="table__status table__status--${b.status}">${b.status}</span></td>
                                <td>
                                    <button class="table__action" onclick="viewBooking('${doc.id}')">View</button>
                                    ${b.guestPhone ? `<a href="https://wa.me/${b.guestPhone.replace(/[^0-9]/g, '')}?text=Hi%20${encodeURIComponent(b.guestName || 'Guest')}!" class="table__action table__action--primary" target="_blank" data-whatsapp>WhatsApp</a>` : ''}
                                </td>
                            </tr>
                        `;
                    }

                    allHtml += `
                        <tr>
                            <td><strong>${b.guestName || 'Guest'}</strong><br><small style="color:var(--color-text-light);">${b.guestEmail || ''}</small></td>
                            <td>${b.property || '-'}</td>
                            <td>${checkIn.toLocaleDateString()}</td>
                            <td>${checkOut.toLocaleDateString()}</td>
                            <td>${nights}</td>
                            <td><strong>‚Ç¨${b.totalPrice || b.totalAmount || 0}</strong></td>
                            <td><span style="font-size:0.7rem;padding:3px 8px;border-radius:10px;background:${sourceColor};color:white;">${source}</span></td>
                            <td><span class="table__status table__status--${b.status}">${b.status}</span></td>
                            <td style="white-space:nowrap;">
                                <button class="table__action" onclick="viewBooking('${doc.id}')">View</button>
                                ${b.guestPhone ? `<a href="https://wa.me/${b.guestPhone.replace(/[^0-9]/g, '')}?text=Bonjour%20${encodeURIComponent(b.guestName || '')}%20!%20Nous%20avons%20bien%20re√ßu%20votre%20r√©servation%20√†%20Masia%20Can%20Pares." class="table__action table__action--primary" target="_blank" style="background:#25D366;border-color:#25D366;" data-whatsapp>
                                    <span class="material-symbols-outlined" style="font-size:14px;vertical-align:middle;">chat</span> WhatsApp
                                </a>` : ''}
                            </td>
                        </tr>
                    `;
                });

                document.getElementById('upcoming-bookings').innerHTML = upcomingHtml || '<tr><td colspan="6" class="empty-state">No upcoming bookings</td></tr>';
                document.getElementById('all-bookings').innerHTML = allHtml;
                updateWhatsAppVisibility(); // Apply WhatsApp visibility
            } catch (error) {
                console.error('Error loading bookings:', error);
            }
        }

        // =====================================================
        // CALENDAR VIEW
        // =====================================================
        var calendarInstance = null;

        async function loadCalendar() {
            try {
                const snapshot = await db.collection('bookings').get();
                const events = [];
                
                const propertyColors = {
                    'Casa Blanca': { background: '#2D4A3E', border: '#2D4A3E' },
                    'Casa Mediterranea': { background: '#A65D57', border: '#A65D57' }
                };

                snapshot.forEach(doc => {
                    const b = doc.data();
                    const checkIn = b.checkIn?.toDate ? b.checkIn.toDate() : new Date(b.checkIn);
                    const checkOut = b.checkOut?.toDate ? b.checkOut.toDate() : new Date(b.checkOut);
                    const colors = propertyColors[b.property] || { background: '#6B635A', border: '#6B635A' };
                    
                    events.push({
                        id: doc.id,
                        title: b.guestName || 'Guest',
                        start: checkIn,
                        end: checkOut,
                        backgroundColor: colors.background,
                        borderColor: colors.border,
                        extendedProps: {
                            property: b.property,
                            guests: b.guests,
                            total: b.totalPrice || b.totalAmount,
                            status: b.status,
                            email: b.guestEmail,
                            phone: b.guestPhone
                        }
                    });
                });

                const calendarEl = document.getElementById('calendar-view');
                
                if (calendarInstance) {
                    calendarInstance.destroy();
                }

                calendarInstance = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,listMonth'
                    },
                    events: events,
                    eventClick: function(info) {
                        const props = info.event.extendedProps;
                        const start = info.event.start.toLocaleDateString();
                        const end = info.event.end ? info.event.end.toLocaleDateString() : '-';
                        
                        alert(
                            'üìÖ ' + info.event.title + '\n\n' +
                            'Property: ' + (props.property || '-') + '\n' +
                            'Check-in: ' + start + '\n' +
                            'Check-out: ' + end + '\n' +
                            'Guests: ' + (props.guests || '-') + '\n' +
                            'Total: ‚Ç¨' + (props.total || 0) + '\n' +
                            'Status: ' + (props.status || '-') + '\n' +
                            'Email: ' + (props.email || '-') + '\n' +
                            'Phone: ' + (props.phone || '-')
                        );
                    },
                    eventDidMount: function(info) {
                        info.el.style.cursor = 'pointer';
                    },
                    height: 'auto'
                });
                
                calendarInstance.render();
            } catch (error) {
                console.error('Error loading calendar:', error);
            }
        }

        async function loadConversations() {
            try {
                const snapshot = await db.collection('conversations').orderBy('lastMessageTime', 'desc').get();
                
                if (snapshot.empty) {
                    document.getElementById('conversations-list').innerHTML = '<div class="empty-state">No conversations yet</div>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const c = doc.data();
                    const time = c.lastMessageTime?.toDate?.() || new Date();
                    const initials = (c.guestName || 'G').split(' ').map(n => n[0]).join('').slice(0,2);
                    
                    html += `
                        <div class="conversation-item" onclick="openConversation('${doc.id}')">
                            <div class="conversation-item__header">
                                <div class="conversation-item__avatar">${initials}</div>
                                <span class="conversation-item__name">${c.guestName || 'Guest'}</span>
                                <span class="conversation-item__time">${time.toLocaleDateString()}</span>
                                ${c.unreadByHost > 0 ? '<span class="conversation-item__unread"></span>' : ''}
                            </div>
                            <div class="conversation-item__preview">${c.lastMessage || 'No messages'}</div>
                        </div>
                    `;
                });

                document.getElementById('conversations-list').innerHTML = html;
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }

        async function openConversation(convId) {
            currentConversation = convId;
            
            // Mark all items as inactive
            document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
            event.currentTarget?.classList.add('active');

            // Get conversation info
            const convDoc = await db.collection('conversations').doc(convId).get();
            const conv = convDoc.data();

            // Update header
            const initials = (conv.guestName || 'G').split(' ').map(n => n[0]).join('').slice(0,2);
            document.getElementById('chat-avatar').textContent = initials;
            document.getElementById('chat-name').textContent = conv.guestName || 'Guest';
            document.getElementById('chat-booking').textContent = conv.bookingRef || 'Direct message';
            document.getElementById('chat-header').style.display = 'flex';
            document.getElementById('chat-input').style.display = 'flex';

            // WhatsApp link
            document.getElementById('whatsapp-btn').onclick = () => {
                window.open(`https://wa.me/${conv.guestPhone?.replace(/[^0-9]/g, '') || WHATSAPP_NUMBER}`, '_blank');
            };

            // Load messages with real-time updates
            db.collection('conversations').doc(convId).collection('messages').orderBy('timestamp').onSnapshot(snapshot => {
                let html = '';
                snapshot.forEach(doc => {
                    const m = doc.data();
                    const isHost = m.senderId === 'admin' || m.senderRole === 'admin' || m.senderType === 'host';
                    const time = m.timestamp?.toDate?.() || new Date();
                    
                    html += `
                        <div class="chat-message chat-message--${isHost ? 'sent' : 'received'}">
                            <div class="chat-message__bubble">${m.text}</div>
                            <div class="chat-message__time">${time.toLocaleString()}</div>
                        </div>
                    `;
                });

                document.getElementById('chat-messages').innerHTML = html || '<div class="empty-state">No messages in this conversation</div>';
                
                // Scroll to bottom
                const msgContainer = document.getElementById('chat-messages');
                msgContainer.scrollTop = msgContainer.scrollHeight;
            });

            // Mark as read
            await db.collection('conversations').doc(convId).update({ unreadByHost: 0 });
            loadStats();
            updateWhatsAppVisibility(); // Apply WhatsApp visibility
        }

        async function sendMessage() {
            if (!currentConversation) return;
            
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;

            input.value = '';

            // Add message (real-time listener will update UI)
            await db.collection('conversations').doc(currentConversation).collection('messages').add({
                text,
                senderId: 'admin',
                senderRole: 'admin',
                senderType: 'host',
                senderName: 'Martin',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            });

            // Update conversation
            await db.collection('conversations').doc(currentConversation).update({
                lastMessage: text,
                lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                unreadByGuest: firebase.firestore.FieldValue.increment(1)
            });
        }

        // Enter to send
        document.getElementById('message-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        async function loadCheckins() {
            try {
                const snapshot = await db.collection('checkins').orderBy('createdAt', 'desc').get();
                
                if (snapshot.empty) {
                    document.getElementById('checkins-list').innerHTML = '<div class="empty-state"><span class="material-symbols-outlined">how_to_reg</span><p>No check-in data yet</p></div>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const c = doc.data();
                    const guests = c.guests || [];
                    
                    html += `
                        <div style="margin-bottom:30px;">
                            <h3 style="margin-bottom:15px;">Booking: ${c.bookingRef || doc.id}</h3>
                            <div class="checkin-details">
                                ${guests.map((g, i) => `
                                    <div class="guest-card">
                                        <div class="guest-card__header">
                                            <span class="guest-card__name">Guest ${i+1}: ${g.firstName} ${g.lastName}</span>
                                            <span class="guest-card__status guest-card__status--complete">Complete</span>
                                        </div>
                                        <div class="guest-card__row"><span class="guest-card__label">Date of Birth</span><span>${g.dateOfBirth || '-'}</span></div>
                                        <div class="guest-card__row"><span class="guest-card__label">Nationality</span><span>${g.nationality || '-'}</span></div>
                                        <div class="guest-card__row"><span class="guest-card__label">ID Type</span><span>${g.idType || '-'}</span></div>
                                        <div class="guest-card__row"><span class="guest-card__label">ID Number</span><span>${g.idNumber || '-'}</span></div>
                                        <div class="guest-card__row"><span class="guest-card__label">ID Document</span><span class="guest-card__id-link" onclick="viewIdDocument('${g.idDocumentUrl}')">View Document</span></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });

                document.getElementById('checkins-list').innerHTML = html;
            } catch (error) {
                console.error('Error loading checkins:', error);
            }
        }

        async function viewIdDocument(url) {
            if (url) {
                window.open(url, '_blank');
            } else {
                alert('No document uploaded');
            }
        }

        async function loadIssues() {
            try {
                const snapshot = await db.collection('issues').orderBy('reportedAt', 'desc').get();
                
                if (snapshot.empty) {
                    document.getElementById('issues-list').innerHTML = '<div class="empty-state"><span class="material-symbols-outlined">check_circle</span><p>No issues reported</p></div>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const i = doc.data();
                    const time = i.reportedAt?.toDate?.() || new Date();
                    
                    html += `
                        <div class="issue-card issue-card--${i.severity}">
                            <div class="issue-card__header">
                                <span class="issue-card__location">${i.property} - ${i.location}</span>
                                <span class="issue-card__severity">${i.severity}</span>
                            </div>
                            <p class="issue-card__desc">${i.description || 'No description'}</p>
                            <div class="issue-card__meta">Reported: ${time.toLocaleString()}</div>
                            <div class="issue-card__actions">
                                <button class="table__action" onclick="resolveIssue('${doc.id}')">Mark Resolved</button>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('issues-list').innerHTML = html;
            } catch (error) {
                console.error('Error loading issues:', error);
            }
        }

        async function resolveIssue(issueId) {
            await db.collection('issues').doc(issueId).update({ status: 'resolved' });
            loadIssues();
            loadStats();
        }

        async function loadCleaningSessions() {
            try {
                const snapshot = await db.collection('cleaning-sessions').orderBy('startTime', 'desc').limit(20).get();
                
                if (snapshot.empty) {
                    document.getElementById('cleaning-sessions').innerHTML = '<tr><td colspan="7" class="empty-state">No cleaning sessions yet</td></tr>';
                } else {
                    let html = '';
                    snapshot.forEach(doc => {
                        const s = doc.data();
                        const date = s.startTime?.toDate?.() || new Date();
                        const duration = s.duration ? `${Math.floor(s.duration/3600)}h ${Math.floor((s.duration%3600)/60)}m` : '-';
                        const statusClass = s.status === 'completed' ? 'confirmed' : 'pending';
                        
                        html += `
                            <tr>
                                <td>${date.toLocaleDateString()}</td>
                                <td>${s.property || '-'}</td>
                                <td>${s.cleaningType || '-'}</td>
                                <td>${s.staffName || '-'}</td>
                                <td>${duration}</td>
                                <td>${s.issuesReported || 0}</td>
                                <td><span class="table__status table__status--${statusClass}">${s.status || 'unknown'}</span></td>
                            </tr>
                        `;
                    });
                    document.getElementById('cleaning-sessions').innerHTML = html;
                }

                // Load inventory alerts
                const alertsSnapshot = await db.collection('inventory-alerts').where('status', '==', 'pending').get();
                
                if (alertsSnapshot.empty) {
                    document.getElementById('inventory-alerts').innerHTML = '<div class="empty-state"><span class="material-symbols-outlined">check_circle</span><p>No inventory alerts</p></div>';
                } else {
                    let alertsHtml = '';
                    alertsSnapshot.forEach(doc => {
                        const a = doc.data();
                        const date = a.reportedAt?.toDate?.() || new Date();
                        const items = a.items || [];
                        
                        alertsHtml += `
                            <div class="issue-card issue-card--medium" style="background:var(--color-cream);border-radius:10px;padding:20px;margin-bottom:15px;border-left:4px solid var(--color-mustard);">
                                <div class="issue-card__header" style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                    <span class="issue-card__location" style="font-weight:600;">${a.property || 'Unknown'}</span>
                                    <span style="font-size:0.8rem;color:var(--color-text-light);">${date.toLocaleDateString()}</span>
                                </div>
                                <p style="color:var(--color-text-light);font-size:0.9rem;margin-bottom:10px;">Low stock items:</p>
                                <ul style="margin-left:20px;">
                                    ${items.map(i => `<li>${i.name}: ${i.count} remaining</li>`).join('')}
                                </ul>
                                <button class="table__action" style="margin-top:15px;" onclick="resolveAlert('${doc.id}')">Mark Resolved</button>
                            </div>
                        `;
                    });
                    document.getElementById('inventory-alerts').innerHTML = alertsHtml;
                }
            } catch (error) {
                console.error('Error loading cleaning sessions:', error);
            }
        }

        async function resolveAlert(alertId) {
            await db.collection('inventory-alerts').doc(alertId).update({ status: 'resolved' });
            loadCleaningSessions();
        }

        // =====================================================
        // BEDS24 SYNC
        // =====================================================
        async function syncBeds24() {
            const btn = document.getElementById('sync-btn');
            btn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;animation:spin 1s linear infinite;">sync</span> Syncing...';
            btn.disabled = true;
            
            try {
                const response = await fetch('https://europe-west1-masia-can-pares.cloudfunctions.net/syncBookings');
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Sync complete!\n\n' + result.message);
                    loadBookings();
                    loadStats();
                } else {
                    alert('‚ùå Sync failed: ' + result.error);
                }
            } catch (error) {
                console.error('Sync error:', error);
                alert('‚ùå Sync failed: ' + error.message);
            } finally {
                btn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;">sync</span> Sync Beds24';
                btn.disabled = false;
            }
        }

        // =====================================================
        // DOCUMENTS MANAGEMENT
        // =====================================================
        var currentDocId = null;

        async function loadDocuments() {
            try {
                var snapshot = await db.collection('guest-documents').orderBy('order').get();
                var container = document.getElementById('documents-config');
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state" style="padding:40px;text-align:center;"><span class="material-symbols-outlined" style="font-size:48px;color:var(--color-text-light);">folder_open</span><p style="margin-top:10px;">No documents yet.</p><p style="font-size:0.85rem;color:var(--color-text-light);">Add guides, house manuals, activity lists for your guests.</p></div>';
                    return;
                }

                var html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;">';
                snapshot.forEach(function(doc) {
                    var d = doc.data();
                    html += '<div style="background:var(--color-cream);border-radius:10px;padding:20px;text-align:center;">';
                    html += '<span class="material-symbols-outlined" style="font-size:40px;color:var(--color-charcoal);">' + (d.icon || 'description') + '</span>';
                    html += '<div style="font-weight:600;margin:10px 0 5px;">' + d.name + '</div>';
                    html += '<div style="font-size:0.8rem;color:var(--color-text-light);margin-bottom:15px;">' + (d.description || '') + '</div>';
                    html += '<div style="display:flex;gap:8px;justify-content:center;">';
                    html += '<button class="table__action" onclick="editDocument(\'' + doc.id + '\')"><span class="material-symbols-outlined" style="font-size:14px;vertical-align:middle;">edit</span></button>';
                    html += '<button class="table__action" onclick="window.open(\'' + d.url + '\', \'_blank\')"><span class="material-symbols-outlined" style="font-size:14px;vertical-align:middle;">open_in_new</span></button>';
                    html += '<button class="table__action" onclick="deleteDocument(\'' + doc.id + '\')" style="color:var(--color-terracotta);"><span class="material-symbols-outlined" style="font-size:14px;vertical-align:middle;">delete</span></button>';
                    html += '</div></div>';
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading documents:', error);
            }
        }

        function addDocument() {
            currentDocId = null;
            document.getElementById('doc-modal-title').textContent = 'Add Document';
            document.getElementById('doc-name').value = '';
            document.getElementById('doc-description').value = '';
            document.getElementById('doc-icon').value = 'home';
            document.getElementById('doc-url').value = '';
            document.getElementById('doc-order').value = '1';
            document.getElementById('document-modal').style.display = 'flex';
        }

        async function editDocument(id) {
            currentDocId = id;
            var doc = await db.collection('guest-documents').doc(id).get();
            var d = doc.data();
            
            document.getElementById('doc-modal-title').textContent = 'Edit Document';
            document.getElementById('doc-name').value = d.name || '';
            document.getElementById('doc-description').value = d.description || '';
            document.getElementById('doc-icon').value = d.icon || 'home';
            document.getElementById('doc-url').value = d.url || '';
            document.getElementById('doc-order').value = d.order || 1;
            document.getElementById('document-modal').style.display = 'flex';
        }

        function closeDocumentModal() {
            document.getElementById('document-modal').style.display = 'none';
        }

        async function saveDocument() {
            var name = document.getElementById('doc-name').value.trim();
            var description = document.getElementById('doc-description').value.trim();
            var icon = document.getElementById('doc-icon').value;
            var url = document.getElementById('doc-url').value.trim();
            var order = parseInt(document.getElementById('doc-order').value) || 1;
            
            if (!name || !url) {
                alert('Please enter document name and URL.');
                return;
            }
            
            var docData = {
                name: name,
                description: description,
                icon: icon,
                url: url,
                order: order,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                if (currentDocId) {
                    await db.collection('guest-documents').doc(currentDocId).update(docData);
                } else {
                    docData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('guest-documents').add(docData);
                }
                alert('Document saved!');
                closeDocumentModal();
                loadDocuments();
            } catch (error) {
                console.error('Error saving document:', error);
                alert('Error saving document.');
            }
        }

        async function deleteDocument(id) {
            if (!confirm('Delete this document?')) return;
            
            try {
                await db.collection('guest-documents').doc(id).delete();
                loadDocuments();
            } catch (error) {
                console.error('Error deleting:', error);
            }
        }

        // =====================================================
        // SERVICES MANAGEMENT
        // =====================================================
        var currentServiceId = null;

        async function loadServices() {
            try {
                var snapshot = await db.collection('services').orderBy('category').get();
                var container = document.getElementById('services-catalog');
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state" style="padding:40px;text-align:center;"><span class="material-symbols-outlined" style="font-size:48px;color:var(--color-text-light);">room_service</span><p style="margin-top:10px;">No services yet.</p><p style="font-size:0.85rem;color:var(--color-text-light);">Add breakfast, massages, activities for your guests.</p></div>';
                    return;
                }

                var html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px;">';
                snapshot.forEach(function(doc) {
                    var s = doc.data();
                    var priceLabel = s.price + '‚Ç¨';
                    if (s.priceType === 'per_person') priceLabel += '/pers';
                    else if (s.priceType === 'per_hour') priceLabel += '/hour';
                    else if (s.priceType === 'per_unit') priceLabel += '/unit';
                    
                    var statusColor = s.active !== false ? 'var(--color-sage)' : 'var(--color-text-light)';
                    var statusText = s.active !== false ? 'Active' : 'Inactive';
                    
                    html += '<div style="background:var(--color-cream);border-radius:10px;padding:20px;">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">';
                    html += '<span class="material-symbols-outlined" style="font-size:32px;color:var(--color-charcoal);">' + (s.icon || 'room_service') + '</span>';
                    html += '<span style="font-size:0.7rem;padding:4px 8px;border-radius:10px;background:' + statusColor + ';color:white;">' + statusText + '</span>';
                    html += '</div>';
                    html += '<div style="font-weight:600;font-size:1.1rem;margin-bottom:5px;">' + s.name + '</div>';
                    html += '<div style="font-size:0.85rem;color:var(--color-text-light);margin-bottom:10px;min-height:40px;">' + (s.description || '') + '</div>';
                    html += '<div style="font-weight:700;font-size:1.2rem;color:var(--color-charcoal);margin-bottom:15px;">' + priceLabel + '</div>';
                    html += '<div style="display:flex;gap:8px;">';
                    html += '<button class="table__action" onclick="editService(\'' + doc.id + '\')"><span class="material-symbols-outlined" style="font-size:14px;vertical-align:middle;">edit</span> Edit</button>';
                    html += '<button class="table__action" onclick="deleteService(\'' + doc.id + '\')" style="color:var(--color-terracotta);"><span class="material-symbols-outlined" style="font-size:14px;vertical-align:middle;">delete</span></button>';
                    html += '</div></div>';
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading services:', error);
            }
        }

        async function loadOrders() {
            try {
                var snapshot = await db.collection('service-orders').orderBy('createdAt', 'desc').limit(20).get();
                var tbody = document.getElementById('orders-list');
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state" style="padding:30px;text-align:center;">No orders yet</td></tr>';
                    document.getElementById('orders-badge').textContent = '0';
                    return;
                }

                var html = '';
                var pendingCount = 0;
                snapshot.forEach(function(doc) {
                    var o = doc.data();
                    var date = o.createdAt?.toDate?.() || new Date();
                    var serviceDate = o.serviceDate?.toDate?.() || new Date();
                    
                    if (o.status === 'pending') pendingCount++;
                    
                    var statusClass = o.status === 'confirmed' ? 'confirmed' : (o.status === 'pending' ? 'pending' : 'incomplete');
                    
                    html += '<tr>';
                    html += '<td>' + date.toLocaleDateString() + '</td>';
                    html += '<td>' + (o.guestName || 'Guest') + '</td>';
                    html += '<td>' + (o.serviceName || '-') + '</td>';
                    html += '<td>' + serviceDate.toLocaleDateString() + ' ' + (o.serviceTime || '') + '</td>';
                    html += '<td><strong>' + (o.total || 0) + '‚Ç¨</strong></td>';
                    html += '<td><span class="table__status table__status--' + statusClass + '">' + o.status + '</span></td>';
                    html += '<td>';
                    if (o.status === 'pending') {
                        html += '<button class="table__action table__action--primary" onclick="confirmOrder(\'' + doc.id + '\')">Confirm</button>';
                        html += '<button class="table__action" onclick="cancelOrder(\'' + doc.id + '\')" style="color:var(--color-terracotta);">Cancel</button>';
                    }
                    html += '</td>';
                    html += '</tr>';
                });
                tbody.innerHTML = html;
                document.getElementById('orders-badge').textContent = pendingCount;
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        function addService() {
            currentServiceId = null;
            document.getElementById('service-modal-title').textContent = 'Add Service';
            document.getElementById('service-name').value = '';
            document.getElementById('service-description').value = '';
            document.getElementById('service-price').value = '';
            document.getElementById('service-price-type').value = 'per_person';
            document.getElementById('service-category').value = 'food';
            document.getElementById('service-icon').value = 'bakery_dining';
            document.getElementById('service-notice').value = '24';
            document.getElementById('service-active').checked = true;
            document.getElementById('service-modal').style.display = 'flex';
        }

        async function editService(id) {
            currentServiceId = id;
            var doc = await db.collection('services').doc(id).get();
            var s = doc.data();
            
            document.getElementById('service-modal-title').textContent = 'Edit Service';
            document.getElementById('service-name').value = s.name || '';
            document.getElementById('service-description').value = s.description || '';
            document.getElementById('service-price').value = s.price || '';
            document.getElementById('service-price-type').value = s.priceType || 'per_person';
            document.getElementById('service-category').value = s.category || 'food';
            document.getElementById('service-icon').value = s.icon || 'bakery_dining';
            document.getElementById('service-notice').value = s.advanceNotice || '24';
            document.getElementById('service-active').checked = s.active !== false;
            document.getElementById('service-modal').style.display = 'flex';
        }

        function closeServiceModal() {
            document.getElementById('service-modal').style.display = 'none';
        }

        async function saveService() {
            var name = document.getElementById('service-name').value.trim();
            var price = parseFloat(document.getElementById('service-price').value) || 0;
            
            if (!name || price <= 0) {
                alert('Please enter service name and price.');
                return;
            }
            
            var serviceData = {
                name: name,
                description: document.getElementById('service-description').value.trim(),
                price: price,
                priceType: document.getElementById('service-price-type').value,
                category: document.getElementById('service-category').value,
                icon: document.getElementById('service-icon').value,
                advanceNotice: parseInt(document.getElementById('service-notice').value) || 0,
                active: document.getElementById('service-active').checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                if (currentServiceId) {
                    await db.collection('services').doc(currentServiceId).update(serviceData);
                } else {
                    serviceData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('services').add(serviceData);
                }
                alert('Service saved!');
                closeServiceModal();
                loadServices();
            } catch (error) {
                console.error('Error saving service:', error);
                alert('Error saving service.');
            }
        }

        async function deleteService(id) {
            if (!confirm('Delete this service?')) return;
            try {
                await db.collection('services').doc(id).delete();
                loadServices();
            } catch (error) {
                console.error('Error deleting:', error);
            }
        }

        async function confirmOrder(id) {
            try {
                await db.collection('service-orders').doc(id).update({ 
                    status: 'confirmed',
                    confirmedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                loadOrders();
            } catch (error) {
                console.error('Error confirming order:', error);
            }
        }

        async function cancelOrder(id) {
            if (!confirm('Cancel this order?')) return;
            try {
                await db.collection('service-orders').doc(id).update({ 
                    status: 'cancelled',
                    cancelledAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                loadOrders();
            } catch (error) {
                console.error('Error cancelling order:', error);
            }
        }

        // =====================================================
        // SETTINGS / PROPERTY MANAGEMENT
        // =====================================================
        var currentPropertyId = null;
        var currentPropertyData = { rooms: [], inventory: [] };

        async function loadPropertiesConfig() {
            try {
                var snapshot = await db.collection('cleaning-config').get();
                var container = document.getElementById('properties-config');
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state" style="padding:40px;text-align:center;"><span class="material-symbols-outlined" style="font-size:48px;color:var(--color-text-light);">home</span><p style="margin-top:10px;">No properties configured yet.</p><button class="table__action table__action--primary" style="margin-top:15px;" onclick="initDefaultConfig()">Load Default Configuration</button></div>';
                    return;
                }

                var html = '';
                snapshot.forEach(function(doc) {
                    var p = doc.data();
                    var roomCount = p.rooms ? p.rooms.length : 0;
                    var taskCount = p.rooms ? p.rooms.reduce(function(sum, r) { return sum + (r.tasks ? r.tasks.length : 0); }, 0) : 0;
                    
                    html += '<div style="background:var(--color-cream);border-radius:10px;padding:20px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;">';
                    html += '<div><div style="font-weight:600;font-size:1.1rem;">' + p.name + '</div>';
                    html += '<div style="font-size:0.85rem;color:var(--color-text-light);">' + roomCount + ' rooms ‚Ä¢ ' + taskCount + ' tasks</div></div>';
                    html += '<div style="display:flex;gap:10px;">';
                    html += '<button class="table__action" onclick="editProperty(\'' + doc.id + '\')"><span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;">edit</span> Edit</button>';
                    html += '<button class="table__action" onclick="deleteProperty(\'' + doc.id + '\')" style="color:var(--color-terracotta);"><span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;">delete</span></button>';
                    html += '</div></div>';
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        async function initDefaultConfig() {
            var defaultConfig = {
                'casa-blanca': {
                    name: 'Casa Blanca',
                    rooms: [
                        { id: 'entrance-cb', name: 'Entrance', icon: 'door_front', tasks: ['Sweep and mop floors', 'Dust surfaces', 'Clean entrance door', 'Clean mirrors', 'Check lights'] },
                        { id: 'living-cb', name: 'Living Room', icon: 'weekend', tasks: ['Vacuum floors and rugs', 'Dust all surfaces', 'Clean windows', 'Arrange cushions', 'Clean TV screen', 'Check TV remote batteries', 'Place welcome book'] },
                        { id: 'kitchen-cb', name: 'Kitchen', icon: 'kitchen', tasks: ['Clean countertops', 'Clean inside fridge', 'Clean oven and stovetop', 'Clean microwave', 'Run/empty dishwasher', 'Clean sink and taps', 'Mop floor', 'Empty bins'] },
                        { id: 'bed1-cb', name: 'Bedroom 1 (Master)', icon: 'king_bed', tasks: ['Strip & replace linens', 'Make bed', 'Vacuum floor', 'Dust surfaces', 'Check wardrobe', 'Place water bottles'] },
                        { id: 'bed2-cb', name: 'Bedroom 2', icon: 'bed', tasks: ['Strip & replace linens', 'Make bed', 'Vacuum floor', 'Dust surfaces', 'Check wardrobe'] },
                        { id: 'bath-cb', name: 'Bathrooms', icon: 'bathtub', tasks: ['Clean toilets', 'Clean showers', 'Clean sinks', 'Clean mirrors', 'Mop floors', 'Replace towels', 'Refill soap'] }
                    ],
                    inventory: [
                        { name: 'Toilet Paper', count: 12, min: 6 },
                        { name: 'Hand Soap', count: 3, min: 2 },
                        { name: 'Shampoo', count: 6, min: 3 },
                        { name: 'Water Bottles', count: 12, min: 6 }
                    ]
                },
                'casa-mediterranea': {
                    name: 'Casa Mediterranea',
                    rooms: [
                        { id: 'entrance-cm', name: 'Entrance', icon: 'door_front', tasks: ['Sweep floors', 'Dust furniture', 'Clean door', 'Clean mirrors', 'Check lights'] },
                        { id: 'living-cm', name: 'Living & Dining', icon: 'weekend', tasks: ['Vacuum rugs', 'Dust surfaces', 'Clean windows', 'Arrange cushions', 'Clean TV'] },
                        { id: 'kitchen-cm', name: 'Kitchen', icon: 'countertops', tasks: ['Clean counters', 'Clean fridge', 'Clean stovetop', 'Clean sink', 'Mop floor', 'Empty bin'] },
                        { id: 'bed1-cm', name: 'Bedroom 1', icon: 'king_bed', tasks: ['Strip & replace linens', 'Make bed', 'Vacuum floor', 'Dust surfaces'] },
                        { id: 'bed2-cm', name: 'Bedroom 2', icon: 'bed', tasks: ['Strip & replace linens', 'Make bed', 'Vacuum floor', 'Dust surfaces'] },
                        { id: 'bath-cm', name: 'Bathrooms', icon: 'bathtub', tasks: ['Clean toilets', 'Clean showers', 'Clean sinks', 'Mop floors', 'Replace towels'] }
                    ],
                    inventory: [
                        { name: 'Toilet Paper', count: 8, min: 4 },
                        { name: 'Hand Soap', count: 2, min: 2 },
                        { name: 'Shampoo', count: 4, min: 2 }
                    ]
                },
                'common-areas': {
                    name: 'Common Areas',
                    rooms: [
                        { id: 'pool', name: 'Pool Area', icon: 'pool', tasks: ['Check pool water', 'Clean pool deck', 'Arrange loungers', 'Place pool towels', 'Empty bins'] },
                        { id: 'bbq', name: 'BBQ Area', icon: 'outdoor_grill', tasks: ['Clean BBQ grill', 'Wipe counters', 'Clean sink', 'Sweep area'] },
                        { id: 'garden', name: 'Garden', icon: 'park', tasks: ['Sweep pathways', 'Remove litter', 'Check garden furniture', 'Water plants'] }
                    ],
                    inventory: [
                        { name: 'Pool Towels', count: 12, min: 8 },
                        { name: 'Charcoal Bags', count: 3, min: 2 }
                    ]
                }
            };

            for (var id in defaultConfig) {
                await db.collection('cleaning-config').doc(id).set(defaultConfig[id]);
            }
            
            alert('Default configuration loaded!');
            loadPropertiesConfig();
        }

        function addProperty() {
            currentPropertyId = null;
            currentPropertyData = { name: '', rooms: [], inventory: [] };
            document.getElementById('modal-title').textContent = 'Add Property';
            document.getElementById('prop-name').value = '';
            document.getElementById('prop-id').value = '';
            document.getElementById('prop-id').disabled = false;
            renderRoomsConfig();
            renderInventoryConfig();
            document.getElementById('property-modal').style.display = 'flex';
        }

        async function editProperty(id) {
            currentPropertyId = id;
            var doc = await db.collection('cleaning-config').doc(id).get();
            currentPropertyData = doc.data();
            
            document.getElementById('modal-title').textContent = 'Edit ' + currentPropertyData.name;
            document.getElementById('prop-name').value = currentPropertyData.name;
            document.getElementById('prop-id').value = id;
            document.getElementById('prop-id').disabled = true;
            
            renderRoomsConfig();
            renderInventoryConfig();
            document.getElementById('property-modal').style.display = 'flex';
        }

        function closePropertyModal() {
            document.getElementById('property-modal').style.display = 'none';
        }

        function renderRoomsConfig() {
            var container = document.getElementById('rooms-config');
            if (!currentPropertyData.rooms || currentPropertyData.rooms.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--color-text-light);">No rooms yet. Click "Add Room" to start.</div>';
                return;
            }
            
            var html = '';
            currentPropertyData.rooms.forEach(function(room, index) {
                html += '<div style="background:#f5f5f5;border-radius:8px;padding:15px;" data-room-index="' + index + '">';
                html += '<div style="display:flex;gap:10px;margin-bottom:10px;">';
                html += '<input type="text" value="' + room.name + '" placeholder="Room name" onchange="updateRoomName(' + index + ', this.value)" style="flex:1;padding:10px;border:1px solid rgba(0,0,0,0.15);border-radius:6px;">';
                html += '<select onchange="updateRoomIcon(' + index + ', this.value)" style="padding:10px;border:1px solid rgba(0,0,0,0.15);border-radius:6px;">';
                var icons = ['door_front', 'weekend', 'kitchen', 'countertops', 'king_bed', 'bed', 'single_bed', 'bathtub', 'deck', 'yard', 'pool', 'outdoor_grill', 'park', 'local_parking', 'warehouse'];
                icons.forEach(function(icon) {
                    html += '<option value="' + icon + '"' + (room.icon === icon ? ' selected' : '') + '>' + icon + '</option>';
                });
                html += '</select>';
                html += '<button onclick="removeRoom(' + index + ')" style="padding:10px;background:none;border:1px solid var(--color-terracotta);color:var(--color-terracotta);border-radius:6px;cursor:pointer;"><span class="material-symbols-outlined" style="font-size:18px;">delete</span></button>';
                html += '</div>';
                html += '<div style="font-size:0.75rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--color-text-light);margin-bottom:8px;">Tasks:</div>';
                html += '<textarea onchange="updateRoomTasks(' + index + ', this.value)" style="width:100%;padding:10px;border:1px solid rgba(0,0,0,0.15);border-radius:6px;min-height:80px;font-family:inherit;" placeholder="One task per line">' + (room.tasks ? room.tasks.join('\n') : '') + '</textarea>';
                html += '</div>';
            });
            container.innerHTML = html;
        }

        function renderInventoryConfig() {
            var container = document.getElementById('inventory-config');
            if (!currentPropertyData.inventory || currentPropertyData.inventory.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:15px;color:var(--color-text-light);">No inventory items. Click "Add Item" to start.</div>';
                return;
            }
            
            var html = '';
            currentPropertyData.inventory.forEach(function(item, index) {
                html += '<div style="display:flex;gap:10px;align-items:center;">';
                html += '<input type="text" value="' + item.name + '" placeholder="Item name" onchange="updateInventoryName(' + index + ', this.value)" style="flex:1;padding:10px;border:1px solid rgba(0,0,0,0.15);border-radius:6px;">';
                html += '<input type="number" value="' + item.count + '" placeholder="Count" onchange="updateInventoryCount(' + index + ', this.value)" style="width:80px;padding:10px;border:1px solid rgba(0,0,0,0.15);border-radius:6px;">';
                html += '<input type="number" value="' + item.min + '" placeholder="Min" onchange="updateInventoryMin(' + index + ', this.value)" style="width:80px;padding:10px;border:1px solid rgba(0,0,0,0.15);border-radius:6px;">';
                html += '<button onclick="removeInventoryItem(' + index + ')" style="padding:10px;background:none;border:1px solid var(--color-terracotta);color:var(--color-terracotta);border-radius:6px;cursor:pointer;"><span class="material-symbols-outlined" style="font-size:18px;">delete</span></button>';
                html += '</div>';
            });
            container.innerHTML = html;
        }

        function addRoom() {
            if (!currentPropertyData.rooms) currentPropertyData.rooms = [];
            var newId = 'room-' + Date.now();
            currentPropertyData.rooms.push({ id: newId, name: '', icon: 'door_front', tasks: [] });
            renderRoomsConfig();
        }

        function removeRoom(index) {
            currentPropertyData.rooms.splice(index, 1);
            renderRoomsConfig();
        }

        function updateRoomName(index, value) {
            currentPropertyData.rooms[index].name = value;
            currentPropertyData.rooms[index].id = value.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();
        }

        function updateRoomIcon(index, value) {
            currentPropertyData.rooms[index].icon = value;
        }

        function updateRoomTasks(index, value) {
            currentPropertyData.rooms[index].tasks = value.split('\n').filter(function(t) { return t.trim() !== ''; });
        }

        function addInventoryItem() {
            if (!currentPropertyData.inventory) currentPropertyData.inventory = [];
            currentPropertyData.inventory.push({ name: '', count: 10, min: 5 });
            renderInventoryConfig();
        }

        function removeInventoryItem(index) {
            currentPropertyData.inventory.splice(index, 1);
            renderInventoryConfig();
        }

        function updateInventoryName(index, value) {
            currentPropertyData.inventory[index].name = value;
        }

        function updateInventoryCount(index, value) {
            currentPropertyData.inventory[index].count = parseInt(value) || 0;
        }

        function updateInventoryMin(index, value) {
            currentPropertyData.inventory[index].min = parseInt(value) || 0;
        }

        async function saveProperty() {
            var name = document.getElementById('prop-name').value.trim();
            var id = document.getElementById('prop-id').value.trim().toLowerCase().replace(/\s+/g, '-');
            
            if (!name || !id) {
                alert('Please enter property name and ID.');
                return;
            }
            
            currentPropertyData.name = name;
            
            try {
                await db.collection('cleaning-config').doc(id).set(currentPropertyData);
                alert('Property saved!');
                closePropertyModal();
                loadPropertiesConfig();
            } catch (error) {
                console.error('Error saving:', error);
                alert('Error saving property.');
            }
        }

        async function deleteProperty(id) {
            if (!confirm('Delete this property? This cannot be undone.')) return;
            
            try {
                await db.collection('cleaning-config').doc(id).delete();
                loadPropertiesConfig();
            } catch (error) {
                console.error('Error deleting:', error);
            }
        }

        function viewBooking(bookingId) {
            alert('Booking details for: ' + bookingId);
            // You can expand this to show a modal with full booking details
        }
    </script>
</body>
</html>
