<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Area | Masia Can Pares</title>
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#722F37">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-cream: #F5F0E1;
            --color-mauve: #A07A7E;
            --color-mustard: #E9B84A;
            --color-sage: #2D4A3E;
            --color-terracotta: #A65D57;
            --color-charcoal: #722F37;
            --color-text: #2C2825;
            --color-text-light: #6B635A;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: #f8f7f4; color: var(--color-text); line-height: 1.6; }
        .loading-screen { position: fixed; inset: 0; background: white; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .loading-screen.hidden { display: none; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(0,0,0,0.1); border-top-color: var(--color-charcoal); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .login-required { display: none; min-height: 100vh; align-items: center; justify-content: center; flex-direction: column; gap: 20px; padding: 40px; text-align: center; }
        .login-required.show { display: flex; }
        .login-required a { padding: 15px 30px; background: var(--color-charcoal); color: white; text-decoration: none; font-family: 'Space Mono', monospace; font-size: 0.8rem; letter-spacing: 0.1em; text-transform: uppercase; }
        .dashboard { display: none; min-height: 100vh; }
        .dashboard.show { display: flex; }
        .sidebar { width: 280px; background: var(--color-charcoal); color: white; position: fixed; top: 0; left: 0; bottom: 0; display: flex; flex-direction: column; z-index: 100; }
        .sidebar-header { padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-logo { height: 40px; filter: brightness(0) invert(1); }
        .sidebar-nav { flex: 1; padding: 20px 0; }
        .sidebar-section { margin-bottom: 25px; }
        .sidebar-title { padding: 0 20px; font-family: 'Space Mono', monospace; font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase; opacity: 0.5; margin-bottom: 10px; }
        .sidebar-link { display: flex; align-items: center; gap: 12px; padding: 12px 20px; font-size: 0.9rem; color: rgba(255,255,255,0.7); cursor: pointer; transition: all 0.2s; position: relative; }
        .sidebar-link:hover { background: rgba(255,255,255,0.05); color: white; }
        .sidebar-link.active { background: rgba(255,255,255,0.1); color: white; }
        .sidebar-link.active::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: var(--color-mustard); }
        .sidebar-badge { margin-left: auto; background: var(--color-terracotta); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; font-weight: 600; }
        .sidebar-badge.warning { background: var(--color-mustard); color: var(--color-charcoal); }
        .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .sidebar-user { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .sidebar-avatar { width: 42px; height: 42px; background: var(--color-sage); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .sidebar-logout { width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: none; color: white; font-family: 'Space Mono', monospace; font-size: 0.7rem; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; border-radius: 6px; }
        .sidebar-logout:hover { background: rgba(255,255,255,0.15); }
        .main { flex: 1; margin-left: 280px; min-height: 100vh; }
        .main-header { background: white; padding: 25px 35px; border-bottom: 1px solid rgba(0,0,0,0.06); }
        .main-title { font-family: 'Space Grotesk', sans-serif; font-size: 1.5rem; font-weight: 600; }
        .main-content { padding: 35px; }
        .alert-banner { background: linear-gradient(135deg, var(--color-mustard) 0%, #d4a43d 100%); color: var(--color-charcoal); padding: 18px 25px; border-radius: 12px; margin-bottom: 25px; display: flex; align-items: center; gap: 15px; }
        .alert-banner-content { flex: 1; }
        .alert-banner-title { font-weight: 600; margin-bottom: 3px; }
        .alert-banner-text { font-size: 0.9rem; opacity: 0.85; }
        .alert-banner-btn { padding: 10px 20px; background: var(--color-charcoal); color: white; border: none; border-radius: 6px; font-family: 'Space Mono', monospace; font-size: 0.7rem; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; white-space: nowrap; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: white; border-radius: 12px; overflow: hidden; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .card-header { padding: 20px 25px; border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; align-items: center; justify-content: space-between; }
        .card-title { font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .card-body { padding: 25px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; border-radius: 12px; padding: 22px; text-align: center; }
        .stat-icon { width: 50px; height: 50px; margin: 0 auto 12px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .stat-icon.sage { background: rgba(45, 74, 62, 0.1); color: var(--color-sage); }
        .stat-icon.terracotta { background: rgba(166, 93, 87, 0.1); color: var(--color-terracotta); }
        .stat-icon.mustard { background: rgba(233, 184, 74, 0.15); color: #9a7a00; }
        .stat-icon.charcoal { background: rgba(114, 47, 55, 0.1); color: var(--color-charcoal); }
        .stat-value { font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; }
        .stat-label { font-size: 0.8rem; color: var(--color-text-light); }
        .booking-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .booking-section h4 { font-family: 'Space Mono', monospace; font-size: 0.65rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--color-text-light); margin-bottom: 12px; }
        .booking-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .booking-row:last-child { border-bottom: none; }
        .booking-label { color: var(--color-text-light); }
        .booking-value { font-weight: 500; }
        .quick-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .quick-action { padding: 20px; background: var(--color-cream); border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.3s; border: none; width: 100%; }
        .quick-action:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .quick-action.urgent { background: linear-gradient(135deg, var(--color-mustard) 0%, var(--color-terracotta) 100%); color: white; }
        .quick-action-label { font-size: 0.85rem; font-weight: 500; margin-top: 10px; }
        .quick-action-badge { font-size: 0.65rem; margin-top: 5px; opacity: 0.7; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group.full { grid-column: 1 / -1; }
        .form-label { display: block; font-family: 'Space Mono', monospace; font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-text-light); margin-bottom: 8px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 14px 16px; border: 1px solid rgba(0,0,0,0.12); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem; transition: border-color 0.3s; background: white; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--color-charcoal); }
        .form-textarea { min-height: 100px; resize: vertical; }
        .guest-card { background: var(--color-cream); border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .guest-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .guest-title { font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .guest-status { padding: 5px 12px; border-radius: 15px; font-size: 0.7rem; font-weight: 600; }
        .guest-status.incomplete { background: rgba(233, 184, 74, 0.2); color: #9a7a00; }
        .guest-status.complete { background: rgba(45, 74, 62, 0.15); color: var(--color-sage); }
        .progress-bar { height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--color-sage), var(--color-mustard)); border-radius: 4px; transition: width 0.5s; }
        .file-upload { border: 2px dashed rgba(0,0,0,0.15); border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; }
        .file-upload:hover { border-color: var(--color-charcoal); background: rgba(0,0,0,0.02); }
        .file-upload.has-file { border-color: var(--color-sage); background: rgba(45, 74, 62, 0.05); }
        .file-upload input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .file-upload-icon { font-size: 40px; color: var(--color-text-light); margin-bottom: 10px; }
        .file-upload-text { font-size: 0.9rem; color: var(--color-text-light); }
        .btn { padding: 14px 28px; border-radius: 8px; font-family: 'Space Mono', monospace; font-size: 0.75rem; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; transition: all 0.3s; border: none; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--color-charcoal); color: white; }
        .btn-primary:hover { background: var(--color-terracotta); }
        .btn-secondary { background: var(--color-cream); color: var(--color-text); }
        .btn-sage { background: var(--color-sage); color: white; }
        .messages-container { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; height: 500px; }
        .messages-list { background: var(--color-cream); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; }
        .messages-list-header { padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.08); font-weight: 600; }
        .messages-list-items { flex: 1; overflow-y: auto; }
        .message-preview { padding: 15px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05); transition: background 0.2s; }
        .message-preview:hover, .message-preview.active { background: rgba(255,255,255,0.5); }
        .message-preview-sender { font-weight: 600; font-size: 0.9rem; margin-bottom: 3px; }
        .message-preview-text { font-size: 0.8rem; color: var(--color-text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-container { background: white; border-radius: 10px; display: flex; flex-direction: column; }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; align-items: center; gap: 15px; }
        .chat-avatar { width: 40px; height: 40px; background: var(--color-sage); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .chat-message { max-width: 75%; }
        .chat-message.received { align-self: flex-start; }
        .chat-message.sent { align-self: flex-end; }
        .chat-bubble { padding: 12px 16px; border-radius: 16px; font-size: 0.9rem; line-height: 1.5; }
        .chat-message.received .chat-bubble { background: var(--color-cream); border-bottom-left-radius: 4px; }
        .chat-message.sent .chat-bubble { background: var(--color-charcoal); color: white; border-bottom-right-radius: 4px; }
        .chat-time { font-size: 0.65rem; color: var(--color-text-light); margin-top: 5px; }
        .chat-message.sent .chat-time { text-align: right; }
        .chat-input { padding: 15px; border-top: 1px solid rgba(0,0,0,0.06); display: flex; gap: 10px; }
        .chat-input input { flex: 1; padding: 12px 16px; border: 1px solid rgba(0,0,0,0.12); border-radius: 25px; font-size: 0.9rem; }
        .chat-input input:focus { outline: none; border-color: var(--color-charcoal); }
        .chat-input button { width: 44px; height: 44px; background: var(--color-charcoal); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; }
        .documents-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .document-card { background: var(--color-cream); border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .document-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .document-name { font-weight: 600; margin: 12px 0 5px; }
        .document-size { font-size: 0.75rem; color: var(--color-text-light); }
        .payment-summary { background: var(--color-cream); border-radius: 10px; padding: 25px; }
        .payment-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.06); }
        .payment-row:last-child { border-bottom: none; }
        .payment-row.total { font-weight: 700; font-size: 1.1rem; border-top: 2px solid rgba(0,0,0,0.1); margin-top: 10px; padding-top: 15px; }
        .payment-row.paid { color: var(--color-sage); }
        .payment-row.due { color: var(--color-terracotta); }
        .payment-btn { width: 100%; padding: 16px; margin-top: 20px; background: var(--color-charcoal); color: white; border: none; border-radius: 8px; font-family: 'Space Mono', monospace; font-size: 0.8rem; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .payment-btn:hover { background: var(--color-terracotta); }
        .profile-header { display: flex; align-items: center; gap: 25px; margin-bottom: 30px; }
        .profile-avatar { width: 100px; height: 100px; background: var(--color-sage); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 2.5rem; font-weight: 600; }
        .profile-name { font-family: 'Space Grotesk', sans-serif; font-size: 1.8rem; margin-bottom: 5px; }
        .profile-email { color: var(--color-text-light); }
        .whatsapp-float { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background: #25D366; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4); cursor: pointer; z-index: 1000; transition: transform 0.3s; text-decoration: none; }
        .whatsapp-float:hover { transform: scale(1.1); }
        .whatsapp-float svg { width: 32px; height: 32px; fill: white; }
        @media (max-width: 1024px) {
            .sidebar { 
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%); 
                z-index: 1000;
                transition: transform 0.3s ease;
            }
            .sidebar.open { 
                transform: translateX(0); 
            }
            .main { margin-left: 0; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .quick-actions { grid-template-columns: repeat(2, 1fr); }
            .booking-grid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .messages-container { grid-template-columns: 1fr; height: auto; }
            .documents-grid { grid-template-columns: repeat(2, 1fr); }
            .mobile-header {
                display: flex !important;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 60px;
                background: var(--color-charcoal);
                color: white;
                align-items: center;
                justify-content: space-between;
                padding: 0 15px;
                z-index: 999;
            }
            .main { padding-top: 70px !important; }
            .mobile-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            }
            .mobile-overlay.show { display: block; }
        }
        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: 1fr; gap: 10px; }
            .quick-actions { grid-template-columns: 1fr; }
            .documents-grid { grid-template-columns: 1fr; }
            .main { padding: 70px 10px 20px 10px !important; }
            .card { border-radius: 12px; }
            .card-header { padding: 15px; }
            .card-body { padding: 15px; }
            .stat-card { padding: 15px; }
            .stat-value { font-size: 1.5rem; }
            .alert-banner { flex-direction: column; text-align: center; gap: 15px; }
            .booking-row { flex-direction: column; align-items: flex-start; gap: 5px; }
            .booking-value { font-weight: 600; }
            .services-grid { grid-template-columns: 1fr !important; }
        }
        .mobile-header { display: none; }
        .mobile-menu-btn { background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 5px; }
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
            <span class="material-symbols-outlined">menu</span>
        </button>
        <span style="font-family:'Space Grotesk',sans-serif;font-weight:600;">Can Pares</span>
        <div style="width:40px;"></div>
    </div>
    <div class="mobile-overlay" id="mobile-overlay" onclick="toggleMobileMenu()"></div>

    <div class="loading-screen" id="loading-screen">
        <div class="spinner"></div>
    </div>

    <div class="login-required" id="login-required">
        <span class="material-symbols-outlined" style="font-size:64px;color:var(--color-terracotta);">lock</span>
        <h1 style="font-family:'Space Grotesk',sans-serif;font-size:1.5rem;">Sign In Required</h1>
        <p>Please sign in to access your member area.</p>
        <a href="login.html">Sign In</a>
    </div>

    <div class="dashboard" id="dashboard">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html"><img src="cdn/logos/canpares-logo.webp" alt="Can Pares" class="sidebar-logo"></a>
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <div class="sidebar-title">Your Stay</div>
                    <div class="sidebar-link active" data-tab="overview">
                        <span class="material-symbols-outlined">dashboard</span>
                        Overview
                    </div>
                    <div class="sidebar-link" data-tab="checkin">
                        <span class="material-symbols-outlined">how_to_reg</span>
                        Online Check-in
                        <span class="sidebar-badge warning" id="checkin-badge">Required</span>
                    </div>
                    <div class="sidebar-link" data-tab="messages">
                        <span class="material-symbols-outlined">chat</span>
                        Messages
                    </div>
                    <div class="sidebar-link" data-tab="services">
                        <span class="material-symbols-outlined">room_service</span>
                        Services
                    </div>
                    <div class="sidebar-link" data-tab="documents">
                        <span class="material-symbols-outlined">folder</span>
                        Guides
                    </div>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-title">Manage</div>
                    <div class="sidebar-link" data-tab="payments">
                        <span class="material-symbols-outlined">payments</span>
                        Payments
                    </div>
                    <div class="sidebar-link" data-tab="profile">
                        <span class="material-symbols-outlined">person</span>
                        My Profile
                    </div>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-avatar" id="user-avatar">G</div>
                    <div>
                        <div id="user-name" style="font-weight:500;">Guest</div>
                        <div id="user-email" style="font-size:0.75rem;opacity:0.6;">email</div>
                    </div>
                </div>
                <button class="sidebar-logout" onclick="logout()">
                    <span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;margin-right:5px;">logout</span>
                    Sign Out
                </button>
            </div>
        </aside>

        <main class="main">
            <header class="main-header">
                <h1 class="main-title" id="page-title">Overview</h1>
            </header>

            <div class="main-content">
                <div class="tab-content active" id="overview">
                    <div class="alert-banner" id="checkin-alert">
                        <span class="material-symbols-outlined">warning</span>
                        <div class="alert-banner-content">
                            <div class="alert-banner-title">Guest Registration Required</div>
                            <div class="alert-banner-text">Spanish law requires all guest details to be registered before your stay.</div>
                        </div>
                        <button class="alert-banner-btn" onclick="switchTab('checkin')">Complete Now</button>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon sage"><span class="material-symbols-outlined">calendar_today</span></div>
                            <div class="stat-value" id="stat-days">-</div>
                            <div class="stat-label">Days until arrival</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon terracotta"><span class="material-symbols-outlined">group</span></div>
                            <div class="stat-value" id="stat-guests">0/0</div>
                            <div class="stat-label">Guests registered</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon mustard"><span class="material-symbols-outlined">euro</span></div>
                            <div class="stat-value" id="stat-balance">-</div>
                            <div class="stat-label">Balance due</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon charcoal"><span class="material-symbols-outlined">description</span></div>
                            <div class="stat-value">4</div>
                            <div class="stat-label">Guides available</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><span class="material-symbols-outlined">hotel</span> Your Booking</span>
                            <span id="booking-ref" style="font-family:'Space Mono',monospace;font-size:0.75rem;color:var(--color-text-light);">-</span>
                        </div>
                        <div class="card-body">
                            <div class="booking-grid">
                                <div class="booking-section">
                                    <h4>Stay Details</h4>
                                    <div class="booking-row">
                                        <span class="booking-label">Property</span>
                                        <span class="booking-value" id="booking-property">-</span>
                                    </div>
                                    <div class="booking-row">
                                        <span class="booking-label">Check-in</span>
                                        <span class="booking-value" id="booking-checkin">-</span>
                                    </div>
                                    <div class="booking-row">
                                        <span class="booking-label">Check-out</span>
                                        <span class="booking-value" id="booking-checkout">-</span>
                                    </div>
                                    <div class="booking-row">
                                        <span class="booking-label">Guests</span>
                                        <span class="booking-value" id="booking-guests">-</span>
                                    </div>
                                </div>
                                <div class="booking-section">
                                    <h4>Payment Status</h4>
                                    <div class="booking-row">
                                        <span class="booking-label">Total</span>
                                        <span class="booking-value" id="booking-total">-</span>
                                    </div>
                                    <div class="booking-row">
                                        <span class="booking-label">Paid</span>
                                        <span class="booking-value" style="color:var(--color-sage);" id="booking-paid">-</span>
                                    </div>
                                    <div class="booking-row">
                                        <span class="booking-label">Balance Due</span>
                                        <span class="booking-value" style="color:var(--color-terracotta);" id="booking-due">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><span class="material-symbols-outlined">bolt</span> Quick Actions</span>
                        </div>
                        <div class="card-body">
                            <div class="quick-actions">
                                <button class="quick-action urgent" onclick="switchTab('checkin')">
                                    <span class="material-symbols-outlined">how_to_reg</span>
                                    <div class="quick-action-label">Register Guests</div>
                                    <div class="quick-action-badge">Required</div>
                                </button>
                                <button class="quick-action" onclick="switchTab('documents')">
                                    <span class="material-symbols-outlined">menu_book</span>
                                    <div class="quick-action-label">House Guide</div>
                                </button>
                                <button class="quick-action" onclick="switchTab('messages')">
                                    <span class="material-symbols-outlined">chat</span>
                                    <div class="quick-action-label">Message Host</div>
                                </button>
                                <button class="quick-action" onclick="switchTab('payments')">
                                    <span class="material-symbols-outlined">payments</span>
                                    <div class="quick-action-label">Pay Balance</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="checkin">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><span class="material-symbols-outlined">gavel</span> Legal Requirement</span>
                        </div>
                        <div class="card-body">
                            <p style="margin-bottom:15px;">Spanish law requires all accommodation providers to register guest information. All guests aged 14 and over must provide their details and a valid ID document.</p>
                            <div style="background:var(--color-cream);padding:15px;border-radius:8px;display:flex;align-items:center;gap:10px;">
                                <span class="material-symbols-outlined" style="color:var(--color-terracotta);">schedule</span>
                                <span>Please complete registration <strong>before your check-in date</strong>.</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><span class="material-symbols-outlined">group</span> Guest Registration</span>
                            <button class="btn btn-secondary" onclick="addGuest()">
                                <span class="material-symbols-outlined">add</span> Add Guest
                            </button>
                        </div>
                        <div class="card-body">
                            <div style="margin-bottom:20px;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="checkin-progress" style="width:0%;"></div>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:0.85rem;">
                                    <span id="checkin-count">0 of 0 guests registered</span>
                                    <span style="color:var(--color-text-light);">Complete all to proceed</span>
                                </div>
                            </div>
                            <div id="guests-container"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><span class="material-symbols-outlined">info</span> Arrival Information</span>
                        </div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Estimated Arrival Time</label>
                                    <input type="time" class="form-input" id="arrival-time" value="16:00">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Mode of Transport</label>
                                    <select class="form-select" id="transport">
                                        <option value="car">Rental Car</option>
                                        <option value="taxi">Taxi / Transfer</option>
                                        <option value="own">Own Vehicle</option>
                                    </select>
                                </div>
                                <div class="form-group full">
                                    <label class="form-label">Special Requests</label>
                                    <textarea class="form-textarea" id="special-requests" placeholder="Let us know if you have any special requirements..."></textarea>
                                </div>
                            </div>
                            <button class="btn btn-sage" onclick="saveCheckin()" id="save-checkin-btn">
                                <span class="material-symbols-outlined">save</span>
                                Save Check-in Information
                            </button>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="messages">
                    <div class="card">
                        <div class="card-body" style="padding:0;">
                            <div class="messages-container">
                                <div class="messages-list">
                                    <div class="messages-list-header">Conversations</div>
                                    <div class="messages-list-items">
                                        <div class="message-preview active">
                                            <div class="message-preview-sender">Martin (Host)</div>
                                            <div class="message-preview-text">Welcome! Let me know if you need anything.</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="chat-container">
                                    <div class="chat-header">
                                        <div class="chat-avatar">M</div>
                                        <div>
                                            <div style="font-weight:600;">Martin</div>
                                            <div style="font-size:0.8rem;color:var(--color-text-light);">Your Host</div>
                                        </div>
                                    </div>
                                    <div class="chat-messages" id="chat-messages">
                                        <div class="chat-message received">
                                            <div class="chat-bubble">Welcome to Can Pares! I'm Martin, your host. Feel free to message me here if you have any questions about your stay.</div>
                                            <div class="chat-time">Today, 10:00</div>
                                        </div>
                                    </div>
                                    <div class="chat-input">
                                        <input type="text" placeholder="Type your message..." id="message-input">
                                        <button onclick="sendMessage()">
                                            <span class="material-symbols-outlined">send</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Services Tab -->
                <div class="tab-content" id="services">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><span class="material-symbols-outlined">room_service</span> Available Services</span>
                        </div>
                        <div class="card-body">
                            <div id="services-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;">
                                <div style="text-align:center;padding:40px;color:var(--color-text-light);grid-column:1/-1;">Loading services...</div>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top:20px;">
                        <div class="card-header">
                            <span class="card-title"><span class="material-symbols-outlined">receipt_long</span> My Orders</span>
                        </div>
                        <div class="card-body">
                            <div id="my-orders">
                                <div style="text-align:center;padding:30px;color:var(--color-text-light);">No orders yet</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Service Modal -->
                <div id="order-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
                    <div style="background:white;border-radius:12px;max-width:450px;width:90%;padding:30px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h2 style="font-family:var(--font-display);" id="order-modal-title">Order Service</h2>
                            <button onclick="closeOrderModal()" style="background:none;border:none;cursor:pointer;font-size:24px;">&times;</button>
                        </div>
                        
                        <div style="text-align:center;margin-bottom:20px;">
                            <span class="material-symbols-outlined" id="order-icon" style="font-size:48px;color:var(--color-charcoal);">room_service</span>
                            <div id="order-service-name" style="font-weight:600;font-size:1.2rem;margin-top:10px;">Service</div>
                            <div id="order-service-desc" style="font-size:0.9rem;color:var(--color-text-light);margin-top:5px;">Description</div>
                        </div>

                        <div style="margin-bottom:15px;">
                            <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Date</label>
                            <input type="date" id="order-date" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;">
                        </div>

                        <div style="margin-bottom:15px;">
                            <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Time</label>
                            <select id="order-time" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;">
                                <option value="08:00">08:00</option>
                                <option value="08:30">08:30</option>
                                <option value="09:00">09:00</option>
                                <option value="09:30">09:30</option>
                                <option value="10:00">10:00</option>
                                <option value="10:30">10:30</option>
                                <option value="11:00">11:00</option>
                                <option value="11:30">11:30</option>
                                <option value="12:00">12:00</option>
                                <option value="12:30">12:30</option>
                                <option value="13:00">13:00</option>
                                <option value="13:30">13:30</option>
                                <option value="14:00">14:00</option>
                                <option value="17:00">17:00</option>
                                <option value="18:00">18:00</option>
                                <option value="19:00">19:00</option>
                                <option value="19:30">19:30</option>
                                <option value="20:00">20:00</option>
                                <option value="20:30">20:30</option>
                                <option value="21:00">21:00</option>
                            </select>
                        </div>

                        <div style="margin-bottom:15px;" id="quantity-row">
                            <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Quantity / Persons</label>
                            <div style="display:flex;align-items:center;gap:15px;">
                                <button onclick="changeQuantity(-1)" style="width:40px;height:40px;border:1px solid rgba(0,0,0,0.15);background:white;border-radius:8px;font-size:1.2rem;cursor:pointer;">−</button>
                                <span id="order-quantity" style="font-size:1.5rem;font-weight:600;min-width:40px;text-align:center;">2</span>
                                <button onclick="changeQuantity(1)" style="width:40px;height:40px;border:1px solid rgba(0,0,0,0.15);background:white;border-radius:8px;font-size:1.2rem;cursor:pointer;">+</button>
                            </div>
                        </div>

                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--color-text-light);margin-bottom:8px;">Special Requests (optional)</label>
                            <textarea id="order-notes" style="width:100%;padding:12px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;font-size:1rem;min-height:60px;" placeholder="Allergies, preferences..."></textarea>
                        </div>

                        <div style="background:var(--color-cream);padding:15px;border-radius:8px;margin-bottom:20px;">
                            <div style="display:flex;justify-content:space-between;font-size:0.9rem;margin-bottom:5px;">
                                <span id="order-price-label">2 × 25€</span>
                                <span id="order-subtotal">50€</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;font-weight:700;font-size:1.1rem;padding-top:10px;border-top:1px solid rgba(0,0,0,0.1);">
                                <span>Total</span>
                                <span id="order-total">50€</span>
                            </div>
                        </div>

                        <button onclick="submitOrder()" style="width:100%;padding:15px;background:var(--color-charcoal);color:white;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;">
                            <span class="material-symbols-outlined" style="vertical-align:middle;margin-right:8px;">send</span>
                            Request Service
                        </button>
                        <p style="text-align:center;font-size:0.8rem;color:var(--color-text-light);margin-top:10px;">Payment on-site • Confirmation within 2 hours</p>
                    </div>
                </div>

                <div class="tab-content" id="documents">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><span class="material-symbols-outlined">auto_stories</span> Essential Guides</span>
                        </div>
                        <div class="card-body">
                            <div class="documents-grid" id="guides-container">
                                <div style="text-align:center;padding:40px;color:var(--color-text-light);grid-column:1/-1;">Loading guides...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="payments">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><span class="material-symbols-outlined">receipt_long</span> Payment Summary</span>
                        </div>
                        <div class="card-body">
                            <div class="payment-summary">
                                <div class="payment-row">
                                    <span>Accommodation</span>
                                    <span id="pay-accommodation">-</span>
                                </div>
                                <div class="payment-row">
                                    <span>Cleaning Fee</span>
                                    <span id="pay-cleaning">-</span>
                                </div>
                                <div class="payment-row">
                                    <span>Tourist Tax</span>
                                    <span id="pay-tax">-</span>
                                </div>
                                <div class="payment-row total">
                                    <span>Total</span>
                                    <span id="pay-total">-</span>
                                </div>
                                <div class="payment-row paid">
                                    <span>Deposit Paid</span>
                                    <span id="pay-paid">-</span>
                                </div>
                                <div class="payment-row due">
                                    <span>Balance Due</span>
                                    <span id="pay-due">-</span>
                                </div>
                                <button class="payment-btn" id="pay-btn" onclick="makePayment()">
                                    <span class="material-symbols-outlined">credit_card</span>
                                    Pay Balance Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="profile">
                    <div class="card">
                        <div class="card-body">
                            <div class="profile-header">
                                <div class="profile-avatar" id="profile-avatar">G</div>
                                <div>
                                    <div class="profile-name" id="profile-name">Guest</div>
                                    <div class="profile-email" id="profile-email">email</div>
                                </div>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-input" id="profile-firstname">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-input" id="profile-lastname">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-input" id="profile-email-input" disabled>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-input" id="profile-phone">
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="saveProfile()">
                                <span class="material-symbols-outlined">save</span>
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <a href="#" id="whatsapp-btn" class="whatsapp-float" target="_blank">
        <svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
    </a>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyDlqtcXUqEctwsvLbXzGOenleNPDwOj4n4",
            authDomain: "masia-can-pares.firebaseapp.com",
            projectId: "masia-can-pares",
            storageBucket: "masia-can-pares.firebasestorage.app",
            messagingSenderId: "898469617158",
            appId: "1:898469617158:web:94f57c383501f81b9d2d87"
        };

        var WHATSAPP_NUMBER = "34612345678";
        var PAYMENT_LINK = "https://pay.qonto.com/votre-lien";

        firebase.initializeApp(firebaseConfig);
        var auth = firebase.auth();
        var db = firebase.firestore();
        var storage = firebase.storage();

        var currentUser = null;
        var currentBooking = null;
        var guestCount = 0;
        var guests = [];

        auth.onAuthStateChanged(function(user) {
            document.getElementById("loading-screen").classList.add("hidden");
            
            if (user) {
                currentUser = user;
                document.getElementById("dashboard").classList.add("show");
                initDashboard();
            } else {
                document.getElementById("login-required").classList.add("show");
            }
        });

        function logout() {
            auth.signOut().then(function() {
                window.location.href = "login.html";
            });
        }

        function initDashboard() {
            var name = currentUser.displayName || "Guest";
            var initials = name.split(" ").map(function(n) { return n[0]; }).join("").slice(0,2).toUpperCase();
            
            document.getElementById("user-name").textContent = name;
            document.getElementById("user-email").textContent = currentUser.email;
            document.getElementById("user-avatar").textContent = initials;
            document.getElementById("profile-name").textContent = name;
            document.getElementById("profile-email").textContent = currentUser.email;
            document.getElementById("profile-avatar").textContent = initials;
            document.getElementById("profile-email-input").value = currentUser.email;

            document.getElementById("whatsapp-btn").href = "https://wa.me/" + WHATSAPP_NUMBER + "?text=" + encodeURIComponent("Hi! I have a booking at Can Pares.");

            loadBooking();
            loadGuides();
            loadServicesForGuest();
            loadMyOrders();
            setupTabs();
        }

        function loadGuides() {
            db.collection("guest-documents").orderBy("order").get()
            .then(function(snapshot) {
                var container = document.getElementById("guides-container");
                
                if (snapshot.empty) {
                    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--color-text-light);grid-column:1/-1;">No guides available yet.</div>';
                    return;
                }

                var html = "";
                snapshot.forEach(function(doc) {
                    var d = doc.data();
                    html += '<div class="document-card" onclick="window.open(\'' + d.url + '\', \'_blank\')" style="cursor:pointer;">';
                    html += '<span class="material-symbols-outlined" style="font-size:40px;color:var(--color-charcoal);">' + (d.icon || 'description') + '</span>';
                    html += '<div class="document-name">' + d.name + '</div>';
                    html += '<div class="document-size">' + (d.description || '') + '</div>';
                    html += '</div>';
                });
                container.innerHTML = html;
                
                // Update guide count in stats if element exists
                var statGuides = document.getElementById("stat-guides");
                if (statGuides) statGuides.textContent = snapshot.size;
            })
            .catch(function(err) {
                console.error("Error loading guides:", err);
                document.getElementById("guides-container").innerHTML = '<div style="text-align:center;padding:40px;color:var(--color-text-light);grid-column:1/-1;">Error loading guides.</div>';
            });
        }

        // =====================================================
        // SERVICES
        // =====================================================
        var currentServiceData = null;
        var orderQuantity = 2;

        function loadServicesForGuest() {
            db.collection("services").get()
            .then(function(snapshot) {
                var container = document.getElementById("services-list");
                
                if (snapshot.empty) {
                    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--color-text-light);grid-column:1/-1;">No services available yet.</div>';
                    return;
                }

                var html = "";
                snapshot.forEach(function(doc) {
                    var s = doc.data();
                    if (s.active === false) return; // Skip inactive services
                    
                    var priceLabel = s.price + "€";
                    if (s.priceType === "per_person") priceLabel += "/pers";
                    else if (s.priceType === "per_hour") priceLabel += "/hour";
                    else if (s.priceType === "per_unit") priceLabel += "/unit";

                    var categoryEmoji = {food: "🍽️", wellness: "💆", activities: "🎯", transport: "🚗", household: "🏠"};
                    
                    html += '<div style="background:white;border-radius:12px;padding:20px;border:1px solid rgba(0,0,0,0.08);cursor:pointer;transition:all 0.3s;" onclick=\'openOrderModal(' + JSON.stringify({id: doc.id, name: s.name, description: s.description, price: s.price, priceType: s.priceType, icon: s.icon, advanceNotice: s.advanceNotice}).replace(/'/g, "\\'") + ')\'>';
                    html += '<div style="display:flex;align-items:start;gap:15px;">';
                    html += '<span class="material-symbols-outlined" style="font-size:36px;color:var(--color-charcoal);">' + (s.icon || 'room_service') + '</span>';
                    html += '<div style="flex:1;">';
                    html += '<div style="font-weight:600;font-size:1.05rem;margin-bottom:5px;">' + s.name + '</div>';
                    html += '<div style="font-size:0.85rem;color:var(--color-text-light);margin-bottom:10px;">' + (s.description || '') + '</div>';
                    html += '<div style="font-weight:700;font-size:1.1rem;color:var(--color-charcoal);">' + priceLabel + '</div>';
                    html += '</div>';
                    html += '<span class="material-symbols-outlined" style="color:var(--color-text-light);">chevron_right</span>';
                    html += '</div></div>';
                });
                container.innerHTML = html;
            })
            .catch(function(err) {
                console.error("Error loading services:", err);
                document.getElementById("services-list").innerHTML = '<div style="text-align:center;padding:40px;color:var(--color-text-light);grid-column:1/-1;">Error loading services.</div>';
            });
        }

        function loadMyOrders() {
            db.collection("service-orders").where("guestId", "==", currentUser.uid).get()
            .then(function(snapshot) {
                var container = document.getElementById("my-orders");
                
                if (snapshot.empty) {
                    container.innerHTML = '<div style="text-align:center;padding:30px;color:var(--color-text-light);"><span class="material-symbols-outlined" style="font-size:48px;display:block;margin-bottom:10px;">shopping_bag</span>No orders yet. Browse our services above!</div>';
                    return;
                }

                // Sort by date (newest first)
                var orders = [];
                snapshot.forEach(function(doc) {
                    var data = doc.data();
                    data.id = doc.id;
                    orders.push(data);
                });
                orders.sort(function(a, b) {
                    var dateA = a.createdAt?.toDate?.() || new Date(0);
                    var dateB = b.createdAt?.toDate?.() || new Date(0);
                    return dateB - dateA;
                });

                var html = "";
                orders.forEach(function(o) {
                    var date = o.serviceDate?.toDate?.() || new Date();
                    var statusConfig = {
                        pending: { color: "#E9B84A", icon: "schedule", label: "Pending" },
                        confirmed: { color: "#2D4A3E", icon: "check_circle", label: "Confirmed" },
                        cancelled: { color: "#A65D57", icon: "cancel", label: "Cancelled" },
                        completed: { color: "#2D4A3E", icon: "task_alt", label: "Completed" }
                    };
                    var status = statusConfig[o.status] || { color: "#6B635A", icon: "help", label: o.status };
                    var canCancel = (o.status === "pending");
                    
                    html += '<div style="background:white;border-radius:12px;padding:20px;margin-bottom:15px;border-left:4px solid ' + status.color + ';box-shadow:0 2px 8px rgba(0,0,0,0.06);">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">';
                    html += '<div style="font-weight:600;font-size:1.1rem;">' + o.serviceName + '</div>';
                    html += '<div style="display:flex;align-items:center;gap:5px;font-size:0.8rem;padding:4px 10px;border-radius:15px;background:' + status.color + ';color:white;"><span class="material-symbols-outlined" style="font-size:14px;">' + status.icon + '</span> ' + status.label + '</div>';
                    html += '</div>';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
                    html += '<div style="font-size:0.9rem;color:var(--color-text-light);"><span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;">calendar_today</span> ' + date.toLocaleDateString() + ' at ' + (o.serviceTime || '-') + '</div>';
                    html += '<div style="font-weight:700;font-size:1.2rem;">' + o.total + '€</div>';
                    html += '</div>';
                    if (o.notes) {
                        html += '<div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(0,0,0,0.08);font-size:0.85rem;color:var(--color-text-light);"><strong>Notes:</strong> ' + o.notes + '</div>';
                    }
                    if (canCancel) {
                        html += '<div style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(0,0,0,0.08);text-align:right;">';
                        html += '<button onclick="cancelOrder(\'' + o.id + '\')" style="padding:8px 16px;background:white;border:1px solid #A65D57;color:#A65D57;border-radius:8px;cursor:pointer;font-size:0.85rem;"><span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;">close</span> Cancel Order</button>';
                        html += '</div>';
                    }
                    html += '</div>';
                });
                container.innerHTML = html;
            })
            .catch(function(err) {
                console.error("Error loading orders:", err);
                document.getElementById("my-orders").innerHTML = '<div style="text-align:center;padding:30px;color:var(--color-text-light);">Error loading orders.</div>';
            });
        }

        function cancelOrder(orderId) {
            if (!confirm("Are you sure you want to cancel this order?")) return;
            
            db.collection("service-orders").doc(orderId).update({
                status: "cancelled",
                cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
                cancelledBy: "guest"
            })
            .then(function() {
                alert("Order cancelled.");
                loadMyOrders();
            })
            .catch(function(err) {
                console.error("Error cancelling order:", err);
                alert("Error cancelling order. Please try again.");
            });
        }

        function openOrderModal(service) {
            currentServiceData = service;
            orderQuantity = 2;
            
            document.getElementById("order-modal-title").textContent = "Order " + service.name;
            document.getElementById("order-icon").textContent = service.icon || "room_service";
            document.getElementById("order-service-name").textContent = service.name;
            document.getElementById("order-service-desc").textContent = service.description || "";
            
            // Set minimum date based on advance notice
            var minDate = new Date();
            minDate.setHours(minDate.getHours() + (service.advanceNotice || 24));
            document.getElementById("order-date").min = minDate.toISOString().split("T")[0];
            document.getElementById("order-date").value = minDate.toISOString().split("T")[0];
            
            // Show/hide quantity based on price type
            if (service.priceType === "fixed") {
                document.getElementById("quantity-row").style.display = "none";
                orderQuantity = 1;
            } else {
                document.getElementById("quantity-row").style.display = "block";
            }
            
            updateOrderTotal();
            document.getElementById("order-modal").style.display = "flex";
        }

        function closeOrderModal() {
            document.getElementById("order-modal").style.display = "none";
        }

        function changeQuantity(delta) {
            orderQuantity = Math.max(1, Math.min(20, orderQuantity + delta));
            document.getElementById("order-quantity").textContent = orderQuantity;
            updateOrderTotal();
        }

        function updateOrderTotal() {
            var total = currentServiceData.price * orderQuantity;
            var priceTypeLabel = "";
            if (currentServiceData.priceType === "per_person") priceTypeLabel = " pers";
            else if (currentServiceData.priceType === "per_hour") priceTypeLabel = " hours";
            else if (currentServiceData.priceType === "per_unit") priceTypeLabel = " units";
            
            document.getElementById("order-price-label").textContent = orderQuantity + priceTypeLabel + " × " + currentServiceData.price + "€";
            document.getElementById("order-subtotal").textContent = total + "€";
            document.getElementById("order-total").textContent = total + "€";
        }

        function submitOrder() {
            var orderDate = document.getElementById("order-date").value;
            var orderTime = document.getElementById("order-time").value;
            var orderNotes = document.getElementById("order-notes").value;
            
            if (!orderDate) {
                alert("Please select a date.");
                return;
            }
            
            var total = currentServiceData.price * orderQuantity;
            
            var orderData = {
                serviceId: currentServiceData.id,
                serviceName: currentServiceData.name,
                servicePrice: currentServiceData.price,
                priceType: currentServiceData.priceType,
                quantity: orderQuantity,
                total: total,
                serviceDate: new Date(orderDate),
                serviceTime: orderTime,
                notes: orderNotes,
                guestId: currentUser.uid,
                guestName: currentUser.displayName || "Guest",
                guestEmail: currentUser.email,
                bookingId: currentBooking?.id || null,
                status: "pending",
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection("service-orders").add(orderData)
            .then(function() {
                alert("Service requested!\n\nWe will confirm your request within 2 hours.\n\nTotal: " + total + "€ (payment on-site)");
                closeOrderModal();
                loadMyOrders();
            })
            .catch(function(err) {
                console.error("Error submitting order:", err);
                alert("Error submitting order. Please try again.");
            });
        }

        function setupTabs() {
            var links = document.querySelectorAll(".sidebar-link");
            links.forEach(function(link) {
                link.addEventListener("click", function() {
                    var tab = this.getAttribute("data-tab");
                    if (tab) switchTab(tab);
                });
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll(".sidebar-link").forEach(function(l) { l.classList.remove("active"); });
            document.querySelectorAll(".tab-content").forEach(function(c) { c.classList.remove("active"); });
            
            var link = document.querySelector('[data-tab="' + tabId + '"]');
            if (link) link.classList.add("active");
            
            var tab = document.getElementById(tabId);
            if (tab) tab.classList.add("active");
            
            // Close mobile menu
            closeMobileMenu();
            
            var titles = {
                overview: "Overview",
                checkin: "Online Check-in",
                messages: "Messages",
                services: "Services",
                documents: "Guides & Documents",
                payments: "Payments",
                profile: "My Profile"
            };
            document.getElementById("page-title").textContent = titles[tabId] || "Overview";
        }

        function loadBooking() {
            db.collection("bookings").where("guestId", "==", currentUser.uid).limit(1).get()
            .then(function(snapshot) {
                if (snapshot.empty) {
                    return db.collection("bookings").where("guestEmail", "==", currentUser.email).limit(1).get();
                }
                return snapshot;
            })
            .then(function(snapshot) {
                if (!snapshot.empty) {
                    var doc = snapshot.docs[0];
                    currentBooking = doc.data();
                    currentBooking.id = doc.id;
                    updateBookingDisplay();
                    initGuestForms();
                    loadMessages(); // Load existing messages
                }
            })
            .catch(function(err) {
                console.error("Error loading booking:", err);
            });
        }

        function updateBookingDisplay() {
            if (!currentBooking) return;

            var checkIn = currentBooking.checkIn?.toDate ? currentBooking.checkIn.toDate() : new Date(currentBooking.checkIn);
            var checkOut = currentBooking.checkOut?.toDate ? currentBooking.checkOut.toDate() : new Date(currentBooking.checkOut);
            var today = new Date();
            var daysUntil = Math.ceil((checkIn - today) / (1000 * 60 * 60 * 24));
            
            document.getElementById("booking-ref").textContent = currentBooking.beds24Id || currentBooking.refCode || currentBooking.id;
            document.getElementById("booking-property").textContent = currentBooking.property || "-";
            document.getElementById("booking-checkin").textContent = checkIn.toLocaleDateString("en-GB", { weekday: "short", day: "numeric", month: "short", year: "numeric" });
            document.getElementById("booking-checkout").textContent = checkOut.toLocaleDateString("en-GB", { weekday: "short", day: "numeric", month: "short", year: "numeric" });
            document.getElementById("booking-guests").textContent = (currentBooking.guests || 1) + " guests";
            
            document.getElementById("stat-days").textContent = daysUntil > 0 ? daysUntil : (daysUntil === 0 ? "Today!" : "In progress");
            guestCount = currentBooking.guests || 1;
            
            var total = currentBooking.totalPrice || currentBooking.totalAmount || 0;
            var paid = currentBooking.paidAmount || 0;
            var due = total - paid;
            
            document.getElementById("booking-total").textContent = "€" + total;
            document.getElementById("booking-paid").textContent = "€" + paid;
            document.getElementById("booking-due").textContent = "€" + due;
            document.getElementById("stat-balance").textContent = "€" + due;
            
            document.getElementById("pay-accommodation").textContent = "€" + total;
            document.getElementById("pay-cleaning").textContent = "€0";
            document.getElementById("pay-tax").textContent = "€0";
            document.getElementById("pay-total").textContent = "€" + total;
            document.getElementById("pay-paid").textContent = "€" + paid;
            document.getElementById("pay-due").textContent = "€" + due;
        }

        function initGuestForms() {
            var container = document.getElementById("guests-container");
            container.innerHTML = "";
            
            for (var i = 0; i < guestCount; i++) {
                addGuestCard(i + 1);
            }
            updateCheckinProgress();
        }

        function addGuestCard(num) {
            var container = document.getElementById("guests-container");
            var card = document.createElement("div");
            card.className = "guest-card";
            card.id = "guest-" + num;
            card.innerHTML = '<div class="guest-header"><span class="guest-title"><span class="material-symbols-outlined">person</span> Guest ' + num + (num === 1 ? " (Primary)" : "") + '</span><span class="guest-status incomplete">Incomplete</span></div><div class="form-grid"><div class="form-group"><label class="form-label">First Name</label><input type="text" class="form-input" placeholder="John"></div><div class="form-group"><label class="form-label">Last Name</label><input type="text" class="form-input" placeholder="Doe"></div><div class="form-group"><label class="form-label">Date of Birth</label><input type="date" class="form-input"></div><div class="form-group"><label class="form-label">Nationality</label><select class="form-select"><option value="">Select...</option><option value="FR">France</option><option value="GB">United Kingdom</option><option value="DE">Germany</option><option value="ES">Spain</option><option value="US">United States</option><option value="OTHER">Other</option></select></div><div class="form-group"><label class="form-label">ID Type</label><select class="form-select"><option value="">Select...</option><option value="passport">Passport</option><option value="national_id">National ID Card</option><option value="driving_license">EU Driving License</option></select></div><div class="form-group"><label class="form-label">ID Number</label><input type="text" class="form-input" placeholder="AB123456"></div><div class="form-group full"><label class="form-label">ID Document Photo</label><div class="file-upload"><input type="file" accept="image/*,application/pdf"><span class="material-symbols-outlined file-upload-icon">cloud_upload</span><div class="file-upload-text">Click or drag to upload</div></div></div></div>';
            container.appendChild(card);
        }

        function addGuest() {
            guestCount++;
            addGuestCard(guestCount);
            updateCheckinProgress();
        }

        function updateCheckinProgress() {
            document.getElementById("stat-guests").textContent = "0/" + guestCount;
            document.getElementById("checkin-count").textContent = "0 of " + guestCount + " guests registered";
            document.getElementById("checkin-progress").style.width = "0%";
        }

        function saveCheckin() {
            alert("Check-in information saved!");
        }

        function loadMessages() {
            if (!currentBooking) return;
            
            var convRef = db.collection("conversations").doc(currentBooking.id);
            
            // Listen for real-time updates
            convRef.collection("messages").orderBy("timestamp").onSnapshot(function(snapshot) {
                var container = document.getElementById("chat-messages");
                container.innerHTML = "";
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state" style="text-align:center;padding:40px;color:#666;">No messages yet. Start a conversation!</div>';
                    return;
                }
                
                snapshot.forEach(function(doc) {
                    var msg = doc.data();
                    var isGuest = msg.senderRole === "guest";
                    var time = msg.timestamp?.toDate ? msg.timestamp.toDate().toLocaleString("en-GB", { day: "numeric", month: "short", hour: "2-digit", minute: "2-digit" }) : "";
                    
                    var msgDiv = document.createElement("div");
                    msgDiv.className = "chat-message " + (isGuest ? "sent" : "received");
                    msgDiv.innerHTML = '<div class="chat-bubble">' + msg.text + '</div><div class="chat-time">' + time + '</div>';
                    container.appendChild(msgDiv);
                });
                
                container.scrollTop = container.scrollHeight;
                
                // Mark messages as read by guest
                convRef.update({ unreadByGuest: 0 }).catch(function(){});
            });
        }

        function sendMessage() {
            var input = document.getElementById("message-input");
            var text = input.value.trim();
            if (!text || !currentBooking) return;

            input.value = "";

            // Save to Firebase (real-time listener will update UI)
            var convRef = db.collection("conversations").doc(currentBooking.id);
            
            // Create or update conversation
            convRef.set({
                guestId: currentUser.uid,
                guestName: currentUser.displayName || currentUser.email,
                guestEmail: currentUser.email,
                bookingRef: currentBooking.refCode || currentBooking.id,
                lastMessage: text,
                lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                unreadByHost: firebase.firestore.FieldValue.increment(1),
                unreadByGuest: 0
            }, { merge: true });

            // Add message
            convRef.collection("messages").add({
                text: text,
                senderId: currentUser.uid,
                senderRole: "guest",
                senderName: currentUser.displayName || currentUser.email,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            });
        }

        function saveProfile() {
            alert("Profile saved!");
        }

        function makePayment() {
            window.open(PAYMENT_LINK, "_blank");
        }

        document.getElementById("message-input").addEventListener("keypress", function(e) {
            if (e.key === "Enter") sendMessage();
        });

        // =====================================================
        // MOBILE MENU FUNCTIONS
        // =====================================================
        function toggleMobileMenu() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.getElementById('mobile-overlay').classList.toggle('show');
        }
        
        function closeMobileMenu() {
            document.querySelector('.sidebar').classList.remove('open');
            document.getElementById('mobile-overlay').classList.remove('show');
        }
    </script>
</body>
</html>
