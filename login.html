<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In | Masia Can Pares</title>
    <meta name="description" content="Access your Masia Can Pares member area.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Space+Mono:wght@400;700&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <link rel="icon" type="image/png" href="cdn/logos/canpares-logo.webp">
    <style>
        :root {
            --color-cream: #F5F0E1;
            --color-mauve: #A07A7E;
            --color-mustard: #E9B84A;
            --color-sage: #2D4A3E;
            --color-terracotta: #A65D57;
            --color-charcoal: #722F37;
            --color-text: #2C2825;
            --color-text-light: #6B635A;
            --font-display: 'Space Grotesk', sans-serif;
            --font-mono: 'Space Mono', monospace;
            --font-body: 'DM Sans', sans-serif;
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-body); background: var(--color-cream); color: var(--color-text); line-height: 1.7; min-height: 100vh; }

        .login-page { display: flex; min-height: 100vh; }
        .login-image { flex: 1; position: relative; display: none; }
        .login-image img { width: 100%; height: 100%; object-fit: cover; }
        .login-image__overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%); display: flex; flex-direction: column; justify-content: flex-end; padding: 60px; color: white; }
        .login-image__quote { font-family: var(--font-display); font-size: 2rem; font-weight: 600; margin-bottom: 20px; line-height: 1.3; }
        .login-image__author { font-family: var(--font-mono); font-size: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; opacity: 0.8; }

        .login-form-panel { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; background: white; }
        .login-form-container { width: 100%; max-width: 400px; }
        .login-logo { display: block; margin-bottom: 50px; text-align: center; }
        .login-logo img { height: 60px; width: auto; margin: 0 auto; }
        .login-header { text-align: center; margin-bottom: 40px; }
        .login-header h1 { font-family: var(--font-display); font-size: 2.2rem; font-weight: 600; margin-bottom: 10px; }
        .login-header p { color: var(--color-text-light); font-size: 0.95rem; }

        .login-tabs { display: flex; margin-bottom: 30px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .login-tab { flex: 1; padding: 15px; font-family: var(--font-mono); font-size: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; text-align: center; background: none; border: none; cursor: pointer; color: var(--color-text-light); position: relative; transition: color 0.3s; }
        .login-tab.active { color: var(--color-charcoal); }
        .login-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: var(--color-charcoal); }

        .login-form { display: none; }
        .login-form.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-family: var(--font-mono); font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-text-light); margin-bottom: 8px; }
        .form-input { width: 100%; padding: 15px 18px; font-family: var(--font-body); font-size: 0.95rem; border: 1px solid rgba(0,0,0,0.15); background: var(--color-cream); transition: all 0.3s; }
        .form-input:focus { outline: none; border-color: var(--color-charcoal); background: white; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .form-checkbox { display: flex; align-items: center; gap: 10px; margin-bottom: 25px; }
        .form-checkbox input { width: 18px; height: 18px; accent-color: var(--color-charcoal); }
        .form-checkbox label { font-size: 0.85rem; color: var(--color-text-light); }
        .form-link { font-size: 0.85rem; color: var(--color-terracotta); text-decoration: underline; cursor: pointer; }

        .form-submit { width: 100%; padding: 18px; font-family: var(--font-mono); font-size: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; font-weight: 700; background: var(--color-charcoal); color: white; border: none; cursor: pointer; transition: background 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .form-submit:hover { background: var(--color-terracotta); }
        .form-submit:disabled { opacity: 0.6; cursor: not-allowed; }
        .form-submit .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
        .form-submit.loading .spinner { display: block; }
        .form-submit.loading span { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .form-divider { display: flex; align-items: center; gap: 15px; margin: 25px 0; }
        .form-divider span { font-size: 0.8rem; color: var(--color-text-light); }
        .form-divider::before, .form-divider::after { content: ''; flex: 1; height: 1px; background: rgba(0,0,0,0.1); }

        .social-login { display: flex; gap: 15px; }
        .social-btn { flex: 1; padding: 14px; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: var(--font-mono); font-size: 0.7rem; letter-spacing: 0.05em; text-transform: uppercase; border: 1px solid rgba(0,0,0,0.15); background: white; cursor: pointer; transition: all 0.3s; }
        .social-btn:hover { background: var(--color-cream); }
        .social-btn svg { width: 18px; height: 18px; }

        .login-footer { text-align: center; margin-top: 40px; padding-top: 30px; border-top: 1px solid rgba(0,0,0,0.1); }
        .login-footer a { font-family: var(--font-mono); font-size: 0.7rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-text-light); text-decoration: none; }

        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; display: none; }
        .alert.show { display: flex; align-items: center; gap: 10px; }
        .alert--error { background: rgba(166, 93, 87, 0.15); color: var(--color-terracotta); }
        .alert--success { background: rgba(45, 74, 62, 0.15); color: var(--color-sage); }
        .alert .material-symbols-outlined { font-size: 20px; }

        .password-strength { height: 4px; background: rgba(0,0,0,0.1); margin-top: 8px; border-radius: 2px; overflow: hidden; }
        .password-strength__bar { height: 100%; width: 0; transition: all 0.3s; }
        .password-strength__bar.weak { width: 33%; background: #e74c3c; }
        .password-strength__bar.medium { width: 66%; background: var(--color-mustard); }
        .password-strength__bar.strong { width: 100%; background: var(--color-sage); }

        .password-wrapper { position: relative; }
        .password-wrapper .form-input { padding-right: 50px; }
        .password-toggle { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--color-text-light); padding: 5px; display: flex; align-items: center; justify-content: center; }
        .password-toggle:hover { color: var(--color-charcoal); }
        .password-toggle .material-symbols-outlined { font-size: 20px; }

        @media (min-width: 1024px) { .login-image { display: block; } }
        @media (max-width: 480px) { .form-row { grid-template-columns: 1fr; } .social-login { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="login-page">
        <div class="login-image">
            <img src="cdn/images/hero/hero-1.webp" alt="Masia Can Pares">
            <div class="login-image__overlay">
                <p class="login-image__quote">"The most magical place we've ever stayed. Every detail was perfect."</p>
                <p class="login-image__author">‚Äî Sarah & James, London</p>
            </div>
        </div>

        <div class="login-form-panel">
            <div class="login-form-container">
                <a href="index.html" class="login-logo">
                    <img src="cdn/logos/canpares-logo.webp" alt="Can Pares">
                </a>

                <div class="login-header">
                    <h1>Welcome</h1>
                    <p>Access your member area to manage your stay</p>
                </div>

                <div class="alert alert--error" id="alert-error">
                    <span class="material-symbols-outlined">error</span>
                    <span id="error-message">Error message</span>
                </div>
                <div class="alert alert--success" id="alert-success">
                    <span class="material-symbols-outlined">check_circle</span>
                    <span id="success-message">Success message</span>
                </div>

                <div class="login-tabs">
                    <button class="login-tab active" data-tab="signin">Sign In</button>
                    <button class="login-tab" data-tab="register">Create Account</button>
                </div>

                <!-- Sign In Form -->
                <form class="login-form active" id="signin-form">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" id="signin-email" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <div class="password-wrapper">
                            <input type="password" class="form-input" id="signin-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('signin-password', this)">
                                <span class="material-symbols-outlined">visibility_off</span>
                            </button>
                        </div>
                    </div>
                    <div class="form-checkbox">
                        <input type="checkbox" id="remember">
                        <label for="remember">Remember me</label>
                        <span class="form-link" style="margin-left: auto;" onclick="resetPassword()">Forgot password?</span>
                    </div>
                    <button type="submit" class="form-submit" id="signin-btn">
                        <div class="spinner"></div>
                        <span>Sign In</span>
                    </button>

                    <div class="form-divider"><span>or continue with</span></div>

                    <div class="social-login">
                        <button type="button" class="social-btn" onclick="signInWithGoogle()">
                            <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                            Google
                        </button>
                    </div>
                </form>

                <!-- Register Form -->
                <form class="login-form" id="register-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-input" id="register-firstname" placeholder="John" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-input" id="register-lastname" placeholder="Doe" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" id="register-email" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="register-phone" placeholder="+33 6 12 34 56 78">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <div class="password-wrapper">
                            <input type="password" class="form-input" id="register-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('register-password', this)">
                                <span class="material-symbols-outlined">visibility_off</span>
                            </button>
                        </div>
                        <div class="password-strength">
                            <div class="password-strength__bar" id="password-bar"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Booking Reference (Optional)</label>
                        <input type="text" class="form-input" id="register-booking" placeholder="CP-2025-XXXX">
                    </div>
                    <div class="form-checkbox">
                        <input type="checkbox" id="terms" required>
                        <label for="terms">I agree to the <a href="#" class="form-link">Terms</a> and <a href="#" class="form-link">Privacy Policy</a></label>
                    </div>
                    <button type="submit" class="form-submit" id="register-btn">
                        <div class="spinner"></div>
                        <span>Create Account</span>
                    </button>
                </form>

                <div class="login-footer">
                    <a href="index.html">‚Üê Back to Website</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // =====================================================
        // üî• FIREBASE CONFIGURATION - REMPLACEZ AVEC VOS VALEURS
        // =====================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDlqtcXUqEctwsvLbXzGOenleNPDwOj4n4",
            authDomain: "masia-can-pares.firebaseapp.com",
            projectId: "masia-can-pares",
            storageBucket: "masia-can-pares.firebasestorage.app",
            messagingSenderId: "898469617158",
            appId: "1:898469617158:web:94f57c383501f81b9d2d87"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // =====================================================
        // UI FUNCTIONS
        // =====================================================

        // Tab switching
        document.querySelectorAll('.login-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-form').classList.add('active');
                hideAlerts();
            });
        });

        // Password strength
        document.getElementById('register-password').addEventListener('input', (e) => {
            const value = e.target.value;
            const bar = document.getElementById('password-bar');
            bar.className = 'password-strength__bar';
            
            if (value.length >= 8 && /[A-Z]/.test(value) && /[0-9]/.test(value) && /[^A-Za-z0-9]/.test(value)) {
                bar.classList.add('strong');
            } else if (value.length >= 6 && (/[A-Z]/.test(value) || /[0-9]/.test(value))) {
                bar.classList.add('medium');
            } else if (value.length > 0) {
                bar.classList.add('weak');
            }
        });

        function showError(message) {
            hideAlerts();
            document.getElementById('error-message').textContent = message;
            document.getElementById('alert-error').classList.add('show');
        }

        function showSuccess(message) {
            hideAlerts();
            document.getElementById('success-message').textContent = message;
            document.getElementById('alert-success').classList.add('show');
        }

        function hideAlerts() {
            document.getElementById('alert-error').classList.remove('show');
            document.getElementById('alert-success').classList.remove('show');
        }

        function togglePassword(inputId, button) {
            var input = document.getElementById(inputId);
            var icon = button.querySelector('.material-symbols-outlined');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.textContent = 'visibility';
            } else {
                input.type = 'password';
                icon.textContent = 'visibility_off';
            }
        }

        function getRedirectUrl() {
            var params = new URLSearchParams(window.location.search);
            if (params.get('admin') === 'true') {
                return 'admin-dashboard.html';
            }
            return 'member-dashboard.html';
        }

        function setLoading(buttonId, loading) {
            const btn = document.getElementById(buttonId);
            btn.disabled = loading;
            btn.classList.toggle('loading', loading);
        }

        // =====================================================
        // AUTHENTICATION FUNCTIONS
        // =====================================================

        // Sign In with Email/Password
        document.getElementById('signin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;

            setLoading('signin-btn', true);
            hideAlerts();

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showSuccess('Login successful! Redirecting...');
                setTimeout(() => {
                    window.location.href = getRedirectUrl();
                }, 1000);
            } catch (error) {
                console.error('Sign in error:', error);
                let message = 'An error occurred. Please try again.';
                if (error.code === 'auth/user-not-found') message = 'No account found with this email.';
                if (error.code === 'auth/wrong-password') message = 'Incorrect password. Please try again.';
                if (error.code === 'auth/invalid-credential') message = 'Incorrect email or password. Please try again.';
                if (error.code === 'auth/invalid-email') message = 'Invalid email address.';
                if (error.code === 'auth/too-many-requests') message = 'Too many attempts. Please try again later.';
                showError(message);
            } finally {
                setLoading('signin-btn', false);
            }
        });

        // Register with Email/Password
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const firstName = document.getElementById('register-firstname').value;
            const lastName = document.getElementById('register-lastname').value;
            const email = document.getElementById('register-email').value;
            const phone = document.getElementById('register-phone').value;
            const password = document.getElementById('register-password').value;
            const bookingRef = document.getElementById('register-booking').value;

            if (password.length < 6) {
                showError('Password must be at least 6 characters.');
                return;
            }

            setLoading('register-btn', true);
            hideAlerts();

            try {
                // Create user
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Update profile
                await user.updateProfile({
                    displayName: `${firstName} ${lastName}`
                });

                // Save to Firestore
                await db.collection('users').doc(user.uid).set({
                    firstName,
                    lastName,
                    email,
                    phone,
                    bookingRef: bookingRef || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // If booking ref provided, link it
                if (bookingRef) {
                    const bookingQuery = await db.collection('bookings').where('refCode', '==', bookingRef).get();
                    if (!bookingQuery.empty) {
                        const bookingDoc = bookingQuery.docs[0];
                        await bookingDoc.ref.update({
                            guestId: user.uid,
                            guestEmail: email
                        });
                    }
                }

                showSuccess('Account created! Redirecting...');
                setTimeout(() => {
                    window.location.href = getRedirectUrl();
                }, 1000);
            } catch (error) {
                console.error('Registration error:', error);
                let message = 'An error occurred. Please try again.';
                if (error.code === 'auth/email-already-in-use') message = 'This email is already registered.';
                if (error.code === 'auth/invalid-email') message = 'Invalid email address.';
                if (error.code === 'auth/weak-password') message = 'Password is too weak.';
                showError(message);
            } finally {
                setLoading('register-btn', false);
            }
        });

        // Sign In with Google
        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            try {
                const result = await auth.signInWithPopup(provider);
                const user = result.user;

                // Check if user exists in Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    // Create user profile
                    const names = user.displayName ? user.displayName.split(' ') : ['', ''];
                    await db.collection('users').doc(user.uid).set({
                        firstName: names[0] || '',
                        lastName: names.slice(1).join(' ') || '',
                        email: user.email,
                        phone: user.phoneNumber || '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                showSuccess('Login successful! Redirecting...');
                setTimeout(() => {
                    window.location.href = getRedirectUrl();
                }, 1000);
            } catch (error) {
                console.error('Google sign in error:', error);
                if (error.code !== 'auth/popup-closed-by-user') {
                    showError('Google sign in failed. Please try again.');
                }
            }
        }

        // Password Reset
        async function resetPassword() {
            const email = document.getElementById('signin-email').value;
            
            if (!email) {
                showError('Please enter your email address first.');
                return;
            }

            try {
                await auth.sendPasswordResetEmail(email);
                showSuccess('Password reset email sent! Check your inbox.');
            } catch (error) {
                console.error('Password reset error:', error);
                if (error.code === 'auth/user-not-found') {
                    showError('No account found with this email.');
                } else {
                    showError('Failed to send reset email. Please try again.');
                }
            }
        }

        // Check if user is already logged in
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in, redirect to dashboard
                window.location.href = getRedirectUrl();
            }
        });
    </script>
</body>
</html>
